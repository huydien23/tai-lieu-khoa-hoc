@using System.IO
@model QuanLyTaiLieuKhoaHoc.Web.Models.ViewModels.TaiLieuViewModel
@{
    ViewData["Title"] = $"Chi tiết: {Model.TenTaiLieu}";
    var breadcrumbItems = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Tài liệu", Url.Action("Index", "TaiLieu"), "fas fa-book"),
        new BreadcrumbItem(Model.TenTaiLieu, null, "fas fa-file-alt")
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/document-details.css" />
}

<div class="document-details-page">
    <!-- Success/Info Messages -->
    @if (TempData["InfoMessage"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="fas fa-info-circle"></i>
            @TempData["InfoMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    
    <!-- Breadcrumb -->
    @await Html.PartialAsync("_Breadcrumb", breadcrumbItems)

    <div class="container">
        <!-- Document Header Section -->
        <div class="document-header-section">
            <div class="document-type-indicator">
                <div class="type-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <span class="type-label">@Model.TenLoaiTaiLieu</span>
            </div>
            
            <h1 class="document-main-title">@Model.TenTaiLieu</h1>
            
            <div class="document-author-info">
                <i class="fas fa-user-circle"></i>
                <span>Tác giả: @Model.TacGia</span>
            </div>
            
            <div class="document-stats">
                <div class="stat-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span>@Model.NgayTaiLen.ToString("dd/MM/yyyy")</span>
                </div>
                @if (Model.ChoPhepTaiFile)
                {
                    <div class="stat-item">
                        <i class="fas fa-download"></i>
                        <span>@Model.LuotTai lượt tải</span>
                    </div>
                }
                <div class="stat-item">
                    <i class="fas fa-book-reader"></i>
                    <span>@Model.SoLuongDaMuon lượt mượn</span>
                </div>
            </div>
        </div>

        <!-- Document Status Banner -->
        <div class="status-banner">
            <div class="status-item">
                <span class="status-label">Tổng số:</span>
                <span class="status-value total">@Model.SoLuong</span>
            </div>
            <div class="status-item">
                <span class="status-label">Đã mượn:</span>
                <span class="status-value borrowed">@Model.SoLuongDaMuon</span>
            </div>
            <div class="status-item">
                <span class="status-label">Còn lại:</span>
                @if (Model.SoLuongConLai > 0)
                {
                    <span class="status-value available">@Model.SoLuongConLai</span>
                }
                else
                {
                    <span class="status-value unavailable">Hết</span>
                }
            </div>
        </div>

        <!-- Main Content -->
        <div class="content-sections">
            <!-- Basic Information Section -->
            <section class="info-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <h2>Thông tin cơ bản</h2>
                </div>
                <div class="section-content">
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Chuyên ngành</label>
                            <div class="info-value">
                                <span class="tag">@Model.TenChuyenNganh</span>
                            </div>
                        </div>
                        <div class="info-item">
                            <label>Kích thước</label>
                            <div class="info-value">
                                @(Model.KichThuocFile >= 1024 ? $"{Math.Round(Model.KichThuocFile / 1024.0, 1)} MB" : $"{Model.KichThuocFile} KB")
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Description Section -->
            <section class="info-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-align-left"></i>
                    </div>
                    <h2>Mô tả</h2>
                </div>
                <div class="section-content">
                    <div class="description-text">
                        @Model.MoTa
                    </div>
                </div>
            </section>

            <!-- Specialized Information Section -->
            @if (Model.TenLoaiTaiLieu != null && Model.TenLoaiTaiLieu.Contains("báo", System.StringComparison.OrdinalIgnoreCase)) {
                <section class="info-section specialized">
                    <div class="section-header special">
                        <div class="section-icon">
                            <i class="fas fa-newspaper"></i>
                        </div>
                        <h2>Thông tin Bài báo khoa học</h2>
                    </div>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Tiêu đề</label>
                                <div class="info-value">@Model.TieuDe</div>
                            </div>
                            <div class="info-item">
                                <label>Tạp chí/Hội nghị</label>
                                <div class="info-value">@Model.TapChiHoiNghi</div>
                            </div>
                            <div class="info-item">
                                <label>Ngày công bố</label>
                                <div class="info-value">@(Model.NgayCongBo?.ToString("dd/MM/yyyy") ?? "")</div>
                            </div>
                            <div class="info-item">
                                <label>DOI</label>
                                <div class="info-value">@Model.DOI</div>
                            </div>
                            <div class="info-item">
                                <label>ISSN</label>
                                <div class="info-value">@Model.ISSN</div>
                            </div>
                            <div class="info-item">
                                <label>Cấp độ</label>
                                <div class="info-value">
                                    <span class="tag">@Model.CapDo</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            }
            else if (Model.TenLoaiTaiLieu != null && Model.TenLoaiTaiLieu.Contains("đề tài", System.StringComparison.OrdinalIgnoreCase)) {
                <section class="info-section specialized">
                    <div class="section-header special">
                        <div class="section-icon">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <h2>Thông tin Đề tài nghiên cứu khoa học</h2>
                    </div>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Tên đề tài</label>
                                <div class="info-value">@Model.TenDeTai</div>
                            </div>
                            <div class="info-item">
                                <label>Mã số đề tài</label>
                                <div class="info-value">
                                    <span class="tag">@Model.MaSoDeTai</span>
                                </div>
                            </div>
                            <div class="info-item">
                                <label>Cấp đề tài</label>
                                <div class="info-value">
                                    <span class="tag">@Model.CapDeTai</span>
                                </div>
                            </div>
                            <div class="info-item">
                                <label>Thời gian thực hiện</label>
                                <div class="info-value">@Model.ThoiGianThucHien</div>
                            </div>
                            <div class="info-item">
                                <label>Cơ quan chủ trì</label>
                                <div class="info-value">@Model.CoQuanChuTri</div>
                            </div>
                            <div class="info-item">
                                <label>Chủ nhiệm đề tài</label>
                                <div class="info-value">@Model.ChuNhiemDeTai</div>
                            </div>
                        </div>
                    </div>
                </section>
            }
            else if (Model.TenLoaiTaiLieu != null && (Model.TenLoaiTaiLieu.Contains("giáo trình", System.StringComparison.OrdinalIgnoreCase) || Model.TenLoaiTaiLieu.Contains("giảng dạy", System.StringComparison.OrdinalIgnoreCase))) {
                <section class="info-section specialized">
                    <div class="section-header special">
                        <div class="section-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <h2>Thông tin Giáo trình - Tài liệu giảng dạy</h2>
                    </div>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <label>Tên giáo trình</label>
                                <div class="info-value">@Model.TenGiaoTrinh</div>
                            </div>
                            <div class="info-item">
                                <label>Môn học liên quan</label>
                                <div class="info-value">@Model.MonHocLienQuan</div>
                            </div>
                            <div class="info-item">
                                <label>Đơn vị phát hành</label>
                                <div class="info-value">@Model.DonViPhatHanh</div>
                            </div>
                            <div class="info-item">
                                <label>Năm xuất bản</label>
                                <div class="info-value">@Model.NamXuatBan</div>
                            </div>
                            <div class="info-item">
                                <label>Số tín chỉ</label>
                                <div class="info-value">
                                    <span class="tag">@Model.SoTinChi</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            }

            <!-- Action Section -->
            <section class="action-section">
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <div class="action-buttons">
                        @if (User.IsInRole("GiangVien"))
                        {
                            if (Model.ChoPhepTaiFile)
                            {
                                var fileExtension = System.IO.Path.GetExtension(Model.DuongDanFile)?.ToLower();
                                var isPdf = fileExtension == ".pdf";
                                
                                @if (isPdf)
                                {
                                    <a href="@Url.Action("ViewPdf", "TaiLieu", new { id = Model.MaTaiLieu })" class="action-btn primary" target="_blank">
                                        <i class="fas fa-eye"></i>
                                        <span>Xem online</span>
                                    </a>
                                }
                                <a href="/TaiLieu/Download/@Model.MaTaiLieu" class="action-btn success">
                                    <i class="fas fa-download"></i>
                                    <span>Tải xuống</span>
                                </a>
                            }
                            @if (Model.IsYeuThich)
                            {
                                <div class="action-btn favorite active" title="Đã yêu thích">
                                    <i class="fas fa-heart"></i>
                                    <span>Đã yêu thích</span>
                                </div>
                            }
                            else
                            {
                                <form asp-action="ThemYeuThich" asp-controller="TaiLieu" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="maTaiLieu" value="@Model.MaTaiLieu" />
                                    <button type="submit" class="action-btn favorite">
                                        <i class="fas fa-heart"></i>
                                        <span>Yêu thích</span>
                                    </button>
                                </form>
                            }
                        }
                        else if (User.IsInRole("SinhVien"))
                        {
                            if (Model.ChoPhepTaiFile)
                            {
                                var fileExtension = System.IO.Path.GetExtension(Model.DuongDanFile)?.ToLower();
                                var isPdf = fileExtension == ".pdf";
                                
                                @if (isPdf)
                                {
                                    <a href="@Url.Action("ViewPdf", "TaiLieu", new { id = Model.MaTaiLieu })" class="action-btn primary" target="_blank">
                                        <i class="fas fa-eye"></i>
                                        <span>Xem online</span>
                                    </a>
                                }
                                <a href="/TaiLieu/Download/@Model.MaTaiLieu" class="action-btn success">
                                    <i class="fas fa-download"></i>
                                    <span>Tải xuống</span>
                                </a>
                                @if (Model.IsYeuThich)
                                {
                                    <div class="action-btn favorite active" title="Đã yêu thích">
                                        <i class="fas fa-heart"></i>
                                        <span>Đã yêu thích</span>
                                    </div>
                                }
                                else
                                {
                                    <form asp-action="ThemYeuThich" asp-controller="TaiLieu" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="maTaiLieu" value="@Model.MaTaiLieu" />
                                        <button type="submit" class="action-btn favorite">
                                            <i class="fas fa-heart"></i>
                                            <span>Yêu thích</span>
                                        </button>
                                    </form>
                                }
                            }
                            else
                            {
                                @if (Model.SoLuongConLai > 0)
                                {
                                    <button type="button" class="action-btn success" data-bs-toggle="modal" data-bs-target="#muonModal">
                                        <i class="fas fa-paper-plane"></i>
                                        <span>Gửi yêu cầu mượn</span>
                                    </button>
                                }
                                else
                                {
                                    <button type="button" class="action-btn disabled" disabled>
                                        <i class="fas fa-times-circle"></i>
                                        <span>Hết tài liệu</span>
                                    </button>
                                }
                                @if (Model.IsYeuThich)
                                {
                                    <div class="action-btn favorite active" title="Đã yêu thích">
                                        <i class="fas fa-heart"></i>
                                        <span>Đã yêu thích</span>
                                    </div>
                                }
                                else
                                {
                                    <form asp-action="ThemYeuThich" asp-controller="TaiLieu" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="maTaiLieu" value="@Model.MaTaiLieu" />
                                        <button type="submit" class="action-btn favorite">
                                            <i class="fas fa-heart"></i>
                                            <span>Yêu thích</span>
                                        </button>
                                    </form>
                                }
                            }
                        }
                    </div>
                }
                else
                {
                    <div class="login-notice">
                        <i class="fas fa-info-circle"></i>
                        <span><a asp-controller="Account" asp-action="Login">Đăng nhập</a> để xem tài liệu.</span>
                    </div>
                }
            </section>

            <!-- Related Documents Section -->
            <section class="related-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-link"></i>
                    </div>
                    <h2>Tài liệu liên quan</h2>
                </div>
                <div class="section-content">
                    <div id="taiLieuLienQuan" class="related-documents">
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <p>Đang tải tài liệu liên quan...</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<!-- Modal Gửi Yêu Cầu Mượn -->
<div class="modal fade" id="muonModal" tabindex="-1" aria-labelledby="muonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="GuiYeuCauMuon" asp-controller="TaiLieu" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="muonModalLabel">Gửi yêu cầu mượn tài liệu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="maTaiLieu" value="@Model.MaTaiLieu" />
                    <div class="mb-3">
                        <label for="ngayMuon" class="form-label">Ngày giờ đến thư viện mượn</label>
                        <input type="datetime-local" class="form-control" id="ngayMuon" name="ngayMuon" required />
                    </div>
                    <div class="mb-3">
                        <label for="lyDo" class="form-label">Lý do mượn</label>
                        <textarea class="form-control" id="lyDo" name="lyDo" rows="2" placeholder="Nhập lý do mượn..."
                            required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane me-2"></i>Gửi yêu cầu mượn
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            loadTaiLieuLienQuan();
        });

        function loadTaiLieuLienQuan() {
            var taiLieuId = @Model.MaTaiLieu;
            
            $.ajax({
                url: '/TaiLieu/GetTaiLieuLienQuan/' + taiLieuId,
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success && response.data && response.data.length > 0) {
                        renderTaiLieuLienQuan(response.data);
                    } else {
                        showNoRelatedDocuments();
                    }
                },
                error: function() {
                    showNoRelatedDocuments();
                }
            });
        }

        function renderTaiLieuLienQuan(taiLieuList) {
            var html = '';
            
            taiLieuList.forEach(function(taiLieu) {
                html += '<div class="related-item">';
                html += '<div class="related-item-content">';
                html += '<h4><a href="/TaiLieu/Details/' + taiLieu.maTaiLieu + '">' + taiLieu.tenTaiLieu + '</a></h4>';
                html += '<p class="related-author">Tác giả: ' + taiLieu.tacGia + '</p>';
                html += '<div class="related-meta">';
                html += '<span class="related-tag">' + taiLieu.tenChuyenNganh + '</span>';
                html += '<span class="related-date">' + formatDate(taiLieu.ngayTaiLen) + '</span>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });
            
            $('#taiLieuLienQuan').html(html);
        }

        function showNoRelatedDocuments() {
            var html = '<div class="no-related">';
            html += '<div class="no-related-icon"><i class="fas fa-info-circle"></i></div>';
            html += '<p>Chưa có tài liệu liên quan.</p>';
            html += '</div>';
            
            $('#taiLieuLienQuan').html(html);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            var date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }
    </script>
}
