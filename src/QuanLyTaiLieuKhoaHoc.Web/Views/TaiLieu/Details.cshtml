@model QuanLyTaiLieuKhoaHoc.Web.Models.ViewModels.TaiLieuViewModel
@{
    ViewData["Title"] = $"Chi tiết: {Model.TenTaiLieu}";
    var breadcrumbItems = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Tài liệu", Url.Action("Index", "TaiLieu"), "fas fa-book"),
        new BreadcrumbItem(Model.TenTaiLieu, null, "fas fa-file-alt")
    };
}

<div class="container py-4">
    <!-- Breadcrumb -->
    @await Html.PartialAsync("_Breadcrumb", breadcrumbItems)

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h1 class="card-title mb-0">@Model.TenTaiLieu</h1>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Người tải lên:</strong> @Model.TacGia
                        </div>
                        <div class="col-md-6">
                            <strong>Ngày tải lên:</strong> @Model.NgayTaiLen.ToString("dd/MM/yyyy HH:mm")
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Chuyên ngành:</strong>
                            <span class="badge bg-success">@Model.TenChuyenNganh</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Loại tài liệu:</strong>
                            <span class="badge bg-primary">@Model.TenLoaiTaiLieu</span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Lượt mượn:</strong> @Model.SoLuongDaMuon
                        </div>
                        <div class="col-md-6">
                            <strong>Kích thước:</strong> @(Model.KichThuocFile >= 1024 ? $"{Math.Round(Model.KichThuocFile / 1024.0, 1)} MB" : $"{Model.KichThuocFile} KB")
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <strong>Tình trạng tài liệu:</strong>
                            <div class="d-flex gap-2 mt-1">
                                <span class="badge bg-primary">Tổng: @Model.SoLuong</span>
                                <span class="badge bg-warning">Đã mượn: @Model.SoLuongDaMuon</span>
                                @if (Model.SoLuongConLai > 0)
                                {
                                    <span class="badge bg-success">Còn lại: @Model.SoLuongConLai</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Hết tài liệu</span>
                                }
                            </div>
                        </div>
                    </div>
                    @if (Model.ChoPhepTaiFile)
                    {
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Lượt tải:</strong> @Model.LuotTai
                            </div>
                        </div>
                    }
                    <div class="mb-4">
                        <h5>Mô tả:</h5>
                        <p class="text-muted">@Model.MoTa</p>
                    </div>
                    @* Hiển thị thông tin chuyên biệt theo loại tài liệu *@
                    @if (Model.TenLoaiTaiLieu != null && Model.TenLoaiTaiLieu.Contains("báo", System.StringComparison.OrdinalIgnoreCase)) {
                        <div class="mb-4 p-3 border rounded bg-light">
                            <h5 class="mb-3 text-primary">
                                <i class="fas fa-newspaper me-2"></i>Thông tin Bài báo khoa học
                            </h5>
                            <table class="table table-sm table-borderless mb-0">
                                <tr><th>Tiêu đề:</th><td>@Model.TieuDe</td></tr>
                                <tr><th>Tạp chí/Hội nghị:</th><td>@Model.TapChiHoiNghi</td></tr>
                                <tr><th>Ngày công bố:</th><td>@(Model.NgayCongBo?.ToString("dd/MM/yyyy") ?? "")</td></tr>
                                <tr><th>DOI:</th><td>@Model.DOI</td></tr>
                                <tr><th>ISSN:</th><td>@Model.ISSN</td></tr>
                                <tr><th>Cấp độ:</th><td>@Model.CapDo</td></tr>
                            </table>
                        </div>
                    }
                    else if (Model.TenLoaiTaiLieu != null && Model.TenLoaiTaiLieu.Contains("đề tài", System.StringComparison.OrdinalIgnoreCase)) {
                        <div class="mb-4 p-3 border rounded bg-light">
                            <h5 class="mb-3 text-success">
                                <i class="fas fa-project-diagram me-2"></i>Thông tin Đề tài nghiên cứu khoa học
                            </h5>
                            <table class="table table-sm table-borderless mb-0">
                                <tr><th>Tên đề tài:</th><td>@Model.TenDeTai</td></tr>
                                <tr><th>Mã số đề tài:</th><td>@Model.MaSoDeTai</td></tr>
                                <tr><th>Cấp đề tài:</th><td>@Model.CapDeTai</td></tr>
                                <tr><th>Thời gian thực hiện:</th><td>@Model.ThoiGianThucHien</td></tr>
                                <tr><th>Cơ quan chủ trì:</th><td>@Model.CoQuanChuTri</td></tr>
                                <tr><th>Chủ nhiệm đề tài:</th><td>@Model.ChuNhiemDeTai</td></tr>
                            </table>
                        </div>
                    }
                    else if (Model.TenLoaiTaiLieu != null && (Model.TenLoaiTaiLieu.Contains("giáo trình", System.StringComparison.OrdinalIgnoreCase) || Model.TenLoaiTaiLieu.Contains("giảng dạy", System.StringComparison.OrdinalIgnoreCase))) {
                        <div class="mb-4 p-3 border rounded bg-light">
                            <h5 class="mb-3 text-warning">
                                <i class="fas fa-book me-2"></i>Thông tin Giáo trình - Tài liệu giảng dạy
                            </h5>
                            <table class="table table-sm table-borderless mb-0">
                                <tr><th>Tên giáo trình:</th><td>@Model.TenGiaoTrinh</td></tr>
                                <tr><th>Môn học liên quan:</th><td>@Model.MonHocLienQuan</td></tr>
                                <tr><th>Đơn vị phát hành:</th><td>@Model.DonViPhatHanh</td></tr>
                                <tr><th>Năm xuất bản:</th><td>@Model.NamXuatBan</td></tr>
                                <tr><th>Số tín chỉ:</th><td>@Model.SoTinChi</td></tr>
                            </table>
                        </div>
                    }
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <div class="d-flex gap-2">
                            @if (User.IsInRole("GiangVien"))
                            {
                                if (Model.ChoPhepTaiFile)
                                {
                                    <a href="/TaiLieu/Download/@Model.MaTaiLieu" class="btn btn-primary">
                                        <i class="fas fa-download me-2"></i>Tải xuống
                                    </a>
                                }
                                <form asp-action="ThemYeuThich" asp-controller="TaiLieu" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="maTaiLieu" value="@Model.MaTaiLieu" />
                                        <button type="submit" class="btn btn-outline-danger">
                                        <i class="fas fa-heart me-2"></i>Yêu thích
                                        </button>
                                        </form>
                            }
                            else if (User.IsInRole("SinhVien"))
                            {
                                if (Model.ChoPhepTaiFile)
                                {
                                    <a href="/TaiLieu/Download/@Model.MaTaiLieu" class="btn btn-primary">
                                        <i class="fas fa-download me-2"></i>Tải xuống
                                    </a>

                                    <form asp-action="ThemYeuThich" asp-controller="TaiLieu" method="post" class="d-inline">
                                        
                                    
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="maTaiLieu" value="@Model.MaTaiLieu" />
                                        <button type="submit" class="btn btn-outline-danger">
                                        <i class="fas fa-heart me-2"></i>Yêu thích
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    @if (Model.SoLuongConLai > 0)
                                    {
                                        <button type="button" class="btn btn-success" data-bs-toggle="modal"
                                            data-bs-target="#muonModal">
                                            <i class="fas fa-paper-plane me-2"></i>Gửi yêu cầu mượn
                                        </button>
                                    }
                                    else
                                    {
                                        <button type="button" class="btn btn-danger" disabled>
                                            <i class="fas fa-times-circle me-2"></i>Hết tài liệu
                                        </button>
                                    }

                                    <form asp-action="ThemYeuThich" asp-controller="TaiLieu" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="maTaiLieu" value="@Model.MaTaiLieu" />
                                        <button type="submit" class="btn btn-outline-danger">
                                        <i class="fas fa-heart me-2"></i>Yêu thích
                                        </button>
                                    </form>
                                }
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <a asp-controller="Account" asp-action="Login">Đăng nhập</a> để xem tài liệu.
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Tài liệu liên quan</h5>
                </div>
                <div class="card-body" id="taiLieuLienQuan">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="text-muted mt-2">Đang tải tài liệu liên quan...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal Gửi Yêu Cầu Mượn -->
<div class="modal fade" id="muonModal" tabindex="-1" aria-labelledby="muonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="GuiYeuCauMuon" asp-controller="TaiLieu" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="muonModalLabel">Gửi yêu cầu mượn tài liệu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="maTaiLieu" value="@Model.MaTaiLieu" />
                    <div class="mb-3">
                        <label for="ngayMuon" class="form-label">Ngày giờ đến thư viện mượn</label>
                        <input type="datetime-local" class="form-control" id="ngayMuon" name="ngayMuon" required />
                    </div>
                    <div class="mb-3">
                        <label for="lyDo" class="form-label">Lý do mượn</label>
                        <textarea class="form-control" id="lyDo" name="lyDo" rows="2" placeholder="Nhập lý do mượn..."
                            required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane me-2"></i>Gửi yêu cầu mượn
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Load tài liệu liên quan khi trang load xong
            loadTaiLieuLienQuan();
        });

        function loadTaiLieuLienQuan() {
            var taiLieuId = @Model.MaTaiLieu;
            
            $.ajax({
                url: '/TaiLieu/GetTaiLieuLienQuan/' + taiLieuId,
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success && response.data && response.data.length > 0) {
                        renderTaiLieuLienQuan(response.data);
                    } else {
                        showNoRelatedDocuments();
                    }
                },
                error: function() {
                    showNoRelatedDocuments();
                }
            });
        }

        function renderTaiLieuLienQuan(taiLieuList) {
            var html = '';
            
            taiLieuList.forEach(function(taiLieu) {
                html += '<div class="mb-3 p-3 border rounded">';
                html += '<h6 class="mb-2"><a href="/TaiLieu/Details/' + taiLieu.maTaiLieu + '" class="text-decoration-none">' + taiLieu.tenTaiLieu + '</a></h6>';
                html += '<p class="text-muted small mb-2">Tác giả: ' + taiLieu.tacGia + '</p>';
                html += '<div class="d-flex justify-content-between align-items-center">';
                html += '<span class="badge bg-success">' + taiLieu.tenChuyenNganh + '</span>';
                html += '<small class="text-muted">' + formatDate(taiLieu.ngayTaiLen) + '</small>';
                html += '</div>';
                html += '</div>';
            });
            
            $('#taiLieuLienQuan').html(html);
        }

        function showNoRelatedDocuments() {
            var html = '<div class="text-center">';
            html += '<i class="fas fa-info-circle text-muted mb-2" style="font-size: 2rem;"></i>';
            html += '<p class="text-muted">Chưa có tài liệu liên quan.</p>';
            html += '</div>';
            
            $('#taiLieuLienQuan').html(html);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            var date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }
    </script>
}
