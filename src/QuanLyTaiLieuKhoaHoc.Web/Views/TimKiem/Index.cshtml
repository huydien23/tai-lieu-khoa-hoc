@model List<QuanLyTaiLieuKhoaHoc.Web.Models.TaiLieu>
@{
    ViewData["Title"] = "Tìm kiếm tài liệu";
}

<div class="container py-4">
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="page-title">
                    <i class="fas fa-search me-3"></i>Tìm kiếm tài liệu
                </h1>
                <p class="page-subtitle">Tìm kiếm tài liệu theo nhiều tiêu chí khác nhau</p>
            </div>
        </div>
    </div>

    <!-- Search Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-search me-2"></i>Tìm kiếm
            </h5>
        </div>
        <div class="card-body">
            <form method="get" class="search-form">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Từ khóa</label>
                        <input type="text" name="q" class="form-control" value="@ViewBag.TimKiem" placeholder="Nhập từ khóa tìm kiếm...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Chuyên ngành</label>
                        <select name="chuyenNganh" class="form-select">
                            <option value="">-- Tất cả --</option>
                            @if (ViewBag.ChuyenNganh != null)
                            {
                                @foreach (var cn in (ViewBag.ChuyenNganh as List<QuanLyTaiLieuKhoaHoc.Web.Models.ChuyenNganh>) ?? new List<QuanLyTaiLieuKhoaHoc.Web.Models.ChuyenNganh>())
                                {
                                    <option value="@cn.MaChuyenNganh" selected="@(cn.MaChuyenNganh == ViewBag.ChuyenNganhSelected)">@cn.TenChuyenNganh</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Loại tài liệu</label>
                        <select name="loaiTaiLieu" class="form-select">
                            <option value="">-- Tất cả --</option>
                            @if (ViewBag.LoaiTaiLieu != null)
                            {
                                @foreach (var lt in (ViewBag.LoaiTaiLieu as List<QuanLyTaiLieuKhoaHoc.Web.Models.LoaiTaiLieu>) ?? new List<QuanLyTaiLieuKhoaHoc.Web.Models.LoaiTaiLieu>())
                                {
                                    <option value="@lt.MaLoaiTaiLieu" selected="@(lt.MaLoaiTaiLieu == ViewBag.LoaiTaiLieuSelected)">@lt.TenLoaiTaiLieu</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-2"></i>Tìm kiếm
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Search Results -->
    @if (ViewBag.TongSoKetQua != null)
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Kết quả tìm kiếm</h5>
            <span class="badge bg-primary">@ViewBag.TongSoKetQua kết quả</span>
        </div>

        @if (Model != null && Model.Any())
        {
            <div class="row">
                @foreach (var item in Model)
                {
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <a href="/TaiLieu/Details/@item.MaTaiLieu" class="text-decoration-none">
                                        @item.TenTaiLieu
                                    </a>
                                </h5>

                                <p class="card-text text-muted small">
                                    @if (!string.IsNullOrEmpty(item.MoTa) && item.MoTa.Length > 100)
                                    {
                                        @(item.MoTa.Substring(0, 100) + "...")
                                    }
                                    else
                                    {
                                        @item.MoTa
                                    }
                                </p>

                                <div class="small text-muted mb-2">
                                    <div><i class="fas fa-graduation-cap me-1"></i>@item.ChuyenNganh?.TenChuyenNganh</div>
                                    <div><i class="fas fa-file-alt me-1"></i>@item.LoaiTaiLieu?.TenLoaiTaiLieu</div>
                                    <div><i class="fas fa-user me-1"></i>@item.NguoiTaiLen?.HoTen</div>
                                    <div><i class="fas fa-calendar me-1"></i>@item.NgayTaiLen.ToString("dd/MM/yyyy")</div>
                                    <div><i class="fas fa-book-reader me-1"></i>@item.LuotMuon lượt mượn</div>
                                </div>
                            </div>

                            <div class="card-footer bg-transparent">
                                <div class="d-flex justify-content-between">
                                    <a href="/TaiLieu/Details/@item.MaTaiLieu" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>Chi tiết
                                    </a>
                                    @* Chỉ thủ thư/admin mới được tải tài liệu *@
                                    @if (User.Identity?.IsAuthenticated == true && (User.IsInRole("ThuThu") || User.IsInRole("Admin")))
                                    {
                                        <a href="/TaiLieu/Download/@item.MaTaiLieu" class="btn btn-outline-success btn-sm">
                                            <i class="fas fa-download me-1"></i>Tải về
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Phân trang -->
            @if (ViewBag.TongSoTrang > 1)
            {
                <nav aria-label="Phân trang tìm kiếm">
                    <ul class="pagination justify-content-center">
                        @if (ViewBag.TrangHienTai > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" href="?q=@ViewBag.TimKiem&chuyenNganh=@ViewBag.ChuyenNganhSelected&loaiTaiLieu=@ViewBag.LoaiTaiLieuSelected&trang=@(ViewBag.TrangHienTai - 1)">Trước</a>
                            </li>
                        }

                        @for (int i = Math.Max(1, ViewBag.TrangHienTai - 2); i <= Math.Min(ViewBag.TongSoTrang, ViewBag.TrangHienTai + 2); i++)
                        {
                            <li class="page-item @(i == ViewBag.TrangHienTai ? "active" : "")">
                                <a class="page-link" href="?q=@ViewBag.TimKiem&chuyenNganh=@ViewBag.ChuyenNganhSelected&loaiTaiLieu=@ViewBag.LoaiTaiLieuSelected&trang=@i">@i</a>
                            </li>
                        }

                        @if (ViewBag.TrangHienTai < ViewBag.TongSoTrang)
                        {
                            <li class="page-item">
                                <a class="page-link" href="?q=@ViewBag.TimKiem&chuyenNganh=@ViewBag.ChuyenNganhSelected&loaiTaiLieu=@ViewBag.LoaiTaiLieuSelected&trang=@(ViewBag.TrangHienTai + 1)">Sau</a>
                            </li>
                        }
                    </ul>
                </nav>
            }
        }
        else
        {
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">Không tìm thấy kết quả</h4>
                <p class="text-muted">Không có tài liệu nào phù hợp với tiêu chí tìm kiếm của bạn.</p>
            </div>
        }
    }
    else
    {
        <div class="text-center py-5">
            <i class="fas fa-search fa-3x text-primary mb-3"></i>
            <h4>Tìm kiếm tài liệu khoa học</h4>
            <p class="text-muted">Nhập từ khóa và chọn tiêu chí để tìm kiếm tài liệu phù hợp.</p>
        </div>
    }
</div>
