@model QuanLyTaiLieuKhoaHoc.Web.Models.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Quản lý mượn trả";
}
<div class="card shadow-sm mt-4">
    <div class="card-header bg-white border-0 py-3">
        <ul class="nav nav-tabs" id="borrowReturnTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="requests-tab" data-bs-toggle="tab" data-bs-target="#requests"
                    type="button" role="tab" aria-controls="requests" aria-selected="true">
                    <i class="fas fa-clipboard-list me-2"></i> Yêu cầu mượn
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="overdue-tab" data-bs-toggle="tab" data-bs-target="#overdue" type="button"
                    role="tab" aria-controls="overdue" aria-selected="false">
                    <i class="fas fa-exclamation-triangle me-2"></i> Tài liệu quá hạn
                    <span id="overdueBadge" class="badge bg-danger ms-2" style="display: none;">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button"
                    role="tab" aria-controls="history" aria-selected="false">
                    <i class="fas fa-history me-2"></i> Lịch sử mượn trả
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="borrowReturnTabsContent">
            <div class="tab-pane fade show active" id="requests" role="tabpanel" aria-labelledby="requests-tab">
                <form id="searchRequestsForm" class="position-relative mb-3" style="max-width: 400px;"
                    autocomplete="off" onsubmit="return false;">
                    <div class="input-group">
                        <input type="text" class="form-control ps-3 pe-5" id="searchRequests"
                            placeholder="Tìm kiếm theo mã số, họ tên...">
                        <button class="btn btn-outline-secondary search-btn" type="button" id="searchRequestsButton"
                            tabindex="0"
                            style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); z-index: 2; border: none; background: none;">
                            <i class="fas fa-search"></i>
                        </button>
                        <button type="button" class="btn btn-link clear-btn p-0" id="clearSearchRequests" tabindex="0"
                            style="position: absolute; right: 2.5rem; top: 50%; transform: translateY(-50%); z-index: 2; color: #aaa; display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </form>
                <partial name="~/Views/PhieuMuonTra/DanhSachYeuCauChoDuyet.cshtml" model="Model.YeuCauMuonTra" />
            </div>
            <div class="tab-pane fade" id="overdue" role="tabpanel" aria-labelledby="overdue-tab">
                <div id="overdueContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Đang tải danh sách tài liệu quá hạn...</p>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                <form id="searchHistoryForm" class="position-relative mb-3" style="max-width: 400px;" autocomplete="off"
                    onsubmit="return false;">
                    <div class="input-group">
                        <input type="text" class="form-control ps-3 pe-5" id="searchHistory"
                            placeholder="Tìm kiếm theo mã số, họ tên...">
                        <button class="btn btn-outline-secondary search-btn" type="button" id="searchHistoryButton"
                            tabindex="0"
                            style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); z-index: 2; border: none; background: none;">
                            <i class="fas fa-search"></i>
                        </button>
                        <button type="button" class="btn btn-link clear-btn p-0" id="clearSearchHistory" tabindex="0"
                            style="position: absolute; right: 2.5rem; top: 50%; transform: translateY(-50%); z-index: 2; color: #aaa; display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </form>
                <partial name="~/Views/PhieuMuonTra/LichSuMuonTra.cshtml" model="Model.LichSuMuonTra" />
            </div>
        </div>
    </div>
    
    <!-- Modal lập phiếu mượn -->
    <div class="modal fade" id="lapPhieuMuonModal" tabindex="-1" aria-labelledby="lapPhieuMuonModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Nội dung sẽ được load động bằng AJAX -->
            </div>
        </div>
    </div>

    <!-- Modal lập phiếu trả -->
    <div class="modal fade" id="lapPhieuTraModal" tabindex="-1" aria-labelledby="lapPhieuTraModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Nội dung sẽ được load động bằng AJAX -->
            </div>
        </div>
    </div>

    <!-- Modal xem chi tiết phiếu -->
    <div class="modal fade" id="xemPhieuModal" tabindex="-1" aria-labelledby="xemPhieuModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Nội dung sẽ được load động bằng AJAX -->
            </div>
        </div>
    </div>
    <style>
        .nav-tabs .nav-link {
            color: #295BA4;
            background: #e3eafc;
            border: none;
            border-radius: 0.5rem 0.5rem 0 0;
            font-weight: 500;
            margin-right: 2px;
            transition: background 0.2s, color 0.2s;
        }

        .nav-tabs .nav-link.active {
            background: #fff;
            color: #1a237e;
            font-weight: 700;
            border-bottom: 2px solid #fff;
            box-shadow: 0 -2px 8px rgba(41, 91, 164, 0.05);
        }

        .nav-tabs {
            border-bottom: 2px solid #295BA4;
        }

        /* Search input custom style */
        .input-group .form-control {
            border: 2px solid #b6d4fe;
            border-radius: 0.4rem;
            box-shadow: none;
            transition: border-color 0.2s;
        }

        .input-group .form-control:focus {
            border-color: #295BA4;
            box-shadow: 0 0 0 2px #e3eafc;
        }

        .input-group .search-btn i,
        .input-group .clear-btn i {
            color: #b0b3b8;
            font-size: 1.1em;
            transition: color 0.2s;
        }

        .input-group .search-btn:hover i,
        .input-group .search-btn:focus i,
        .input-group .clear-btn:hover i,
        .input-group .clear-btn:focus i {
            color: #295BA4;
        }

        .input-group .search-btn,
        .input-group .clear-btn {
            background: none;
            border: none;
            outline: none;
            box-shadow: none;
        }

        .input-group .form-control::placeholder {
            color: #6c757d;
            opacity: 1;
        }
    </style>
</div>
@section Scripts {
    <script>
        // Thanh tìm kiếm tab Yêu cầu mượn
        $(document).ready(function () {
            var $inputReq = $('#searchRequests');
            var $clearReq = $('#clearSearchRequests');
            var $btnReq = $('#searchRequestsButton');
            $inputReq.on('input', function () {
                if ($inputReq.val()) {
                    $clearReq.show();
                } else {
                    $clearReq.hide();
                }
                filterRequests();
            });
            $clearReq.on('click', function () {
                $inputReq.val('');
                $clearReq.hide();
                $inputReq.focus();
                filterRequests();
            });
            $btnReq.on('click', function () {
                filterRequests();
            });
            $inputReq.on('keydown', function (e) {
                if (e.key === 'Enter') {
                    filterRequests();
                }
            });
            function filterRequests() {
                var value = $inputReq.val().toLowerCase();
                $('#requests table tbody tr').filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            }

            // Thanh tìm kiếm tab Lịch sử mượn trả
            var $inputHis = $('#searchHistory');
            var $clearHis = $('#clearSearchHistory');
            var $btnHis = $('#searchHistoryButton');
            $inputHis.on('input', function () {
                if ($inputHis.val()) {
                    $clearHis.show();
                } else {
                    $clearHis.hide();
                }
                filterHistory();
            });
            $clearHis.on('click', function () {
                $inputHis.val('');
                $clearHis.hide();
                $inputHis.focus();
                filterHistory();
            });
            $btnHis.on('click', function () {
                filterHistory();
            });
            $inputHis.on('keydown', function (e) {
                if (e.key === 'Enter') {
                    filterHistory();
                }
            });
            function filterHistory() {
                var value = $inputHis.val().toLowerCase();
                $('#history table tbody tr').filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            }
        });

        // Load số lượng tài liệu quá hạn khi trang load
        $(document).ready(function() {
            loadSoTaiLieuQuaHan();
            
            // Load nội dung tài liệu quá hạn khi click vào tab
            $('#overdue-tab').on('click', function() {
                loadOverdueContent();
            });
        });

        function loadSoTaiLieuQuaHan() {
            $.get('/PhieuMuonTra/GetSoTaiLieuQuaHan', function(data) {
                if (data.soLuong > 0) {
                    $('#overdueBadge').text(data.soLuong).show();
                } else {
                    $('#overdueBadge').hide();
                }
            });
        }

        function loadOverdueContent() {
            $('#overdueContent').html(`
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Đang tải danh sách tài liệu quá hạn...</p>
                </div>
            `);
            
            $.get('/PhieuMuonTra/DanhSachTaiLieuQuaHan', function(data) {
                // Extract table content from the response
                var parser = new DOMParser();
                var doc = parser.parseFromString(data, 'text/html');
                var tableContent = doc.querySelector('.table-responsive');
                
                if (tableContent) {
                    $('#overdueContent').html(tableContent.outerHTML);
                } else {
                    $('#overdueContent').html(`
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            Không có tài liệu nào quá hạn trả!
                        </div>
                    `);
                }
            }).fail(function() {
                $('#overdueContent').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Có lỗi xảy ra khi tải danh sách tài liệu quá hạn!
                    </div>
                `);
            });
        }

        window.openLapPhieuMuonModal = function(maPhieu) {
            $('#lapPhieuMuonModal').remove();
            // Thêm modal mới vào body
            $('body').append('<div class="modal fade" id="lapPhieuMuonModal" tabindex="-1" aria-labelledby="lapPhieuMuonModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"></div></div></div>');
            $.get('/PhieuMuonTra/LapPhieuMuon', { maPhieu: maPhieu }, function(html) {
                $('#lapPhieuMuonModal .modal-content').html(html);
                $('#lapPhieuMuonModal').modal({ backdrop: 'static', keyboard: false });
                $('#lapPhieuMuonModal').modal('show');
            });
        };

        // Đảm bảo luôn submit qua AJAX kể cả khi modal được tạo lại động
        $(document).on('submit', '#lapPhieuMuonForm', function(e) {
            e.preventDefault();
            var formData = $(this).serialize();
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message);
                        $('#lapPhieuMuonModal').modal('hide');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function() {
                    toastr.error('Có lỗi xảy ra khi lập phiếu mượn!');
                }
            });
        });

        // Reset nội dung modal khi đóng để tránh form cũ còn tồn tại
        $('#lapPhieuMuonModal').on('hidden.bs.modal', function () {
            $(this).find('.modal-content').html('');
        });

        // Function để mở modal trả tài liệu
        window.openLapPhieuTraModal = function(maPhieu) {
            $('#lapPhieuTraModal').remove();
            // Thêm modal mới vào body
            $('body').append('<div class="modal fade" id="lapPhieuTraModal" tabindex="-1" aria-labelledby="lapPhieuTraModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"></div></div></div>');
            $.get('/PhieuMuonTra/LapPhieuTra', { maPhieu: maPhieu }, function(html) {
                $('#lapPhieuTraModal .modal-content').html(html);
                $('#lapPhieuTraModal').modal({ backdrop: 'static', keyboard: false });
                $('#lapPhieuTraModal').modal('show');
            });
        };

        // Function để mở modal xem chi tiết phiếu
        window.openXemPhieuModal = function(maPhieu) {
            $('#xemPhieuModal').remove();
            // Thêm modal mới vào body
            $('body').append('<div class="modal fade" id="xemPhieuModal" tabindex="-1" aria-labelledby="xemPhieuModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"></div></div></div>');
            $.get('/PhieuMuonTra/XemPhieu', { maPhieu: maPhieu }, function(html) {
                $('#xemPhieuModal .modal-content').html(html);
                $('#xemPhieuModal').modal({ backdrop: 'static', keyboard: false });
                $('#xemPhieuModal').modal('show');
            });
        };

        // Đảm bảo luôn submit qua AJAX cho form trả tài liệu
        $(document).on('submit', '#lapPhieuTraForm', function(e) {
            e.preventDefault();
            var formData = $(this).serialize();
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message);
                        $('#lapPhieuTraModal').modal('hide');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function() {
                    toastr.error('Có lỗi xảy ra khi trả tài liệu!');
                }
            });
        });

        // Reset nội dung modal trả tài liệu khi đóng
        $('#lapPhieuTraModal').on('hidden.bs.modal', function () {
            $(this).find('.modal-content').html('');
        });

        // Reset nội dung modal xem chi tiết khi đóng
        $('#xemPhieuModal').on('hidden.bs.modal', function () {
            $(this).find('.modal-content').html('');
        });
    </script>
}
