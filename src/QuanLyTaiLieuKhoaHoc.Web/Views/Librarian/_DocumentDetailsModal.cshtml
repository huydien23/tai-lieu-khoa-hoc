@model QuanLyTaiLieuKhoaHoc.Web.Models.TaiLieu
@using QuanLyTaiLieuKhoaHoc.Web.Models

<div class="container-fluid">
    <form id="editTaiLieuForm" enctype="multipart/form-data">
    <div class="card shadow rounded-4 border-0 p-3" style="background: #f8fafc;">
        <div class="row g-4">
            <!-- Cột trái: Thông tin mô tả và tác giả -->
            <div class="col-md-6">
                <div class="h-100 d-flex flex-column justify-content-between">
                    <div>
                        <h4 class="fw-bold text-primary mb-3">
            <span class="tai-lieu-view"><i class="fas fa-file-alt me-2"></i>@Model.TenTaiLieu</span>
            <input type="text" class="tai-lieu-edit d-none form-control" id="TenTaiLieuInput" name="TenTaiLieu" value="@Model.TenTaiLieu" />
                        </h4>
                        <hr class="my-2">
                        <div class="mb-3">
            <span class="fw-semibold text-muted"><i class="fas fa-align-left me-1"></i>Mô tả:</span>
            <div class="tai-lieu-view text-muted small">@Model.MoTa</div>
            <textarea class="tai-lieu-edit d-none form-control" id="MoTaInput" name="MoTa">@Model.MoTa</textarea>
                        </div>
                        <div class="mb-3">
            <span class="fw-semibold text-muted"><i class="fas fa-user-edit me-1"></i>Tác giả:</span>
            <span class="tai-lieu-view text-dark ms-1">@(Model.TacGia ?? "Chưa xác định")</span>
            <input type="text" class="tai-lieu-edit d-none form-control" id="TacGiaInput" name="TacGia" value="@Model.TacGia" />
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-6 mb-2">
                                <span class="fw-semibold text-muted"><i class="fas fa-layer-group me-1"></i>Chuyên ngành:</span>
                                <span class="tai-lieu-view badge rounded-pill bg-gradient bg-secondary ms-1 px-3 py-2"><i class="fas fa-book-reader me-1"></i>@(Model.ChuyenNganh?.TenChuyenNganh ?? "Chưa phân loại")</span>
                                    <select class="tai-lieu-edit d-none form-select" id="MaChuyenNganhInput"
                                        name="MaChuyenNganh">
                                        @{
                                            var chuyenNganhList = ViewBag.ChuyenNganh as SelectList ?? new
                                            SelectList(Enumerable.Empty<SelectListItem>());
                                            foreach (var cn in chuyenNganhList)
                                            {
                                                if (Model.MaChuyenNganh == int.Parse((string)cn.Value))
                                                {
                                                    <option value="@cn.Value" selected>@cn.Text</option>
                                                }
                                                else
                                                {
                                                    <option value="@cn.Value">@cn.Text</option>
                                                }
                                            }
                                        }
                                    </select>
                            </div>
                            <div class="col-sm-6 mb-2">
                                <span class="fw-semibold text-muted"><i class="fas fa-tag me-1"></i>Loại tài liệu:</span>
                                <span class="tai-lieu-view badge rounded-pill bg-info text-dark ms-1 px-3 py-2"><i class="fas fa-cube me-1"></i>@(Model.LoaiTaiLieu?.TenLoaiTaiLieu ?? "Chưa phân loại")</span>
                                <select class="tai-lieu-edit d-none form-select" id="MaLoaiTaiLieuInput" name="MaLoaiTaiLieu">
                                    @{
                                        var loaiTaiLieuList = ViewBag.LoaiTaiLieu as SelectList ?? new SelectList(Enumerable.Empty<SelectListItem>());
                                        foreach (var lt in loaiTaiLieuList)
                                        {
                                            if (Model.MaLoaiTaiLieu == int.Parse((string)lt.Value))
                                            {
                                                <option value="@lt.Value" selected>@lt.Text</option>
                                            }
                                            else
                                            {
                                                <option value="@lt.Value">@lt.Text</option>
                                            }
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-6 mb-2">
                                <span class="fw-semibold text-muted"><i class="fas fa-user me-1"></i>Tác giả:</span>
                                <span class="ms-1">@(Model.TacGia ?? "Không rõ")</span>
                            </div>
                            <div class="col-sm-6 mb-2">
                                <span class="fw-semibold text-muted"><i class="fas fa-calendar me-1"></i>Ngày tải lên:</span>
                                <span class="ms-1">@Model.NgayTaiLen.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-6 mb-2">
                                <span class="fw-semibold text-muted"><i class="fas fa-copy me-1"></i>Số lượng:</span>
                                <span class="tai-lieu-view ms-1">
                                    <span class="badge bg-primary">Tổng: @Model.SoLuong</span>
                                    <span class="badge bg-warning">Đã mượn: @Model.SoLuongDaMuon</span>
                                    @if (Model.SoLuongConLai > 0)
                                    {
                                        <span class="badge bg-success">Còn lại: @Model.SoLuongConLai</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Hết</span>
                                    }
                                </span>
                                <div class="tai-lieu-edit d-none">
                                    <input type="number" class="form-control" name="SoLuong" value="@Model.SoLuong" min="1" />
                                    <small class="text-muted">Đang mượn: @Model.SoLuongDaMuon</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Cột phải: Thông tin chi tiết đặc thù -->
            <div class="col-md-6">
                <div class="h-100 bg-white rounded-4 border p-3 shadow-sm">
                    <h6 class="fw-semibold text-primary mb-3">
                        <i class="fas fa-info-circle me-1"></i>Thông tin @Model.LoaiTaiLieu?.TenLoaiTaiLieu
                    </h6>
                    <table class="table table-sm table-striped table-bordered rounded mb-0">
                        <tbody>
                            @if (Model.LoaiTaiLieu?.TenLoaiTaiLieu != null)
                            {
                                @switch (Model.LoaiTaiLieu.TenLoaiTaiLieu.ToLower())
                                {
                                    case "bài báo khoa học":
                                        <tr><td class="fw-semibold">Tiêu đề:</td><td><span class="tai-lieu-view">@Model.TieuDe</span><input class="tai-lieu-edit d-none form-control" name="TieuDe" value="@Model.TieuDe" /></td></tr>
                                        <tr><td class="fw-semibold">Tạp chí/Hội nghị:</td><td><span class="tai-lieu-view">@Model.TapChiHoiNghi</span><input class="tai-lieu-edit d-none form-control" name="TapChiHoiNghi" value="@Model.TapChiHoiNghi" /></td></tr>
                                        <tr><td class="fw-semibold">Ngày công bố:</td><td><span class="tai-lieu-view">@(Model.NgayCongBo?.ToString("yyyy-MM-dd") ?? "")</span><input class="tai-lieu-edit d-none form-control" type="date" name="NgayCongBo" value="@(Model.NgayCongBo?.ToString("yyyy-MM-dd") ?? "")" /></td></tr>
                                        <tr><td class="fw-semibold">DOI:</td><td><span class="tai-lieu-view">@Model.DOI</span><input class="tai-lieu-edit d-none form-control" name="DOI" value="@Model.DOI" /></td></tr>
                                        <tr><td class="fw-semibold">ISSN:</td><td><span class="tai-lieu-view">@Model.ISSN</span><input class="tai-lieu-edit d-none form-control" name="ISSN" value="@Model.ISSN" /></td></tr>
                                        <tr><td class="fw-semibold">Cấp độ:</td><td><span class="tai-lieu-view">@Model.CapDo</span><input class="tai-lieu-edit d-none form-control" name="CapDo" value="@Model.CapDo" /></td></tr>
                                        break;

                                    case "đề tài nghiên cứu khoa học":
                                        <tr><td class="fw-semibold">Tên đề tài:</td><td><span class="tai-lieu-view">@Model.TenDeTai</span><input class="tai-lieu-edit d-none form-control" name="TenDeTai" value="@Model.TenDeTai" /></td></tr>
                                        <tr><td class="fw-semibold">Mã số đề tài:</td><td><span class="tai-lieu-view">@Model.MaSoDeTai</span><input class="tai-lieu-edit d-none form-control" name="MaSoDeTai" value="@Model.MaSoDeTai" /></td></tr>
                                        <tr><td class="fw-semibold">Cấp đề tài:</td><td><span class="tai-lieu-view">@Model.CapDeTai</span><input class="tai-lieu-edit d-none form-control" name="CapDeTai" value="@Model.CapDeTai" /></td></tr>
                                        <tr><td class="fw-semibold">Thời gian thực hiện:</td><td><span class="tai-lieu-view">@Model.ThoiGianThucHien</span><input class="tai-lieu-edit d-none form-control" name="ThoiGianThucHien" value="@Model.ThoiGianThucHien" /></td></tr>
                                        <tr><td class="fw-semibold">Cơ quan chủ trì:</td><td><span class="tai-lieu-view">@Model.CoQuanChuTri</span><input class="tai-lieu-edit d-none form-control" name="CoQuanChuTri" value="@Model.CoQuanChuTri" /></td></tr>
                                        <tr><td class="fw-semibold">Chủ nhiệm đề tài:</td><td><span class="tai-lieu-view">@Model.ChuNhiemDeTai</span><input class="tai-lieu-edit d-none form-control" name="ChuNhiemDeTai" value="@Model.ChuNhiemDeTai" /></td></tr>
                                        break;

                                    case "giáo trình":
                                    case "giáo trình - tài liệu giảng dạy":
                                        <tr><td class="fw-semibold">Tên giáo trình:</td><td><span class="tai-lieu-view">@Model.TenGiaoTrinh</span><input class="tai-lieu-edit d-none form-control" name="TenGiaoTrinh" value="@Model.TenGiaoTrinh" /></td></tr>
                                        <tr><td class="fw-semibold">Môn học liên quan:</td><td><span class="tai-lieu-view">@Model.MonHocLienQuan</span><input class="tai-lieu-edit d-none form-control" name="MonHocLienQuan" value="@Model.MonHocLienQuan" /></td></tr>
                                        <tr><td class="fw-semibold">Đơn vị phát hành:</td><td><span class="tai-lieu-view">@Model.DonViPhatHanh</span><input class="tai-lieu-edit d-none form-control" name="DonViPhatHanh" value="@Model.DonViPhatHanh" /></td></tr>
                                        <tr><td class="fw-semibold">Năm xuất bản:</td><td><span class="tai-lieu-view">@(Model.NamXuatBan?.ToString() ?? "")</span><input class="tai-lieu-edit d-none form-control" type="number" name="NamXuatBan" value="@(Model.NamXuatBan?.ToString() ?? "")" /></td></tr>
                                        <tr><td class="fw-semibold">Số tín chỉ:</td><td><span class="tai-lieu-view">@(Model.SoTinChi?.ToString() ?? "")</span><input class="tai-lieu-edit d-none form-control" type="number" name="SoTinChi" value="@(Model.SoTinChi?.ToString() ?? "")" /></td></tr>
                                        break;

                                    case "bài giảng":
                                        <tr><td class="fw-semibold">Môn học:</td><td><span class="tai-lieu-view">@Model.MonHocLienQuan</span><input class="tai-lieu-edit d-none form-control" name="MonHocLienQuan" value="@Model.MonHocLienQuan" /></td></tr>
                                        <tr><td class="fw-semibold">Giảng viên:</td><td><span class="tai-lieu-view">@Model.TacGia</span></td></tr>
                                        <tr><td class="fw-semibold">Học kỳ:</td><td><span class="tai-lieu-view">@Model.ThoiGianThucHien</span><input class="tai-lieu-edit d-none form-control" name="ThoiGianThucHien" value="@Model.ThoiGianThucHien" /></td></tr>
                                        <tr><td class="fw-semibold">Năm học:</td><td><span class="tai-lieu-view">@(Model.NamXuatBan?.ToString() ?? "")</span><input class="tai-lieu-edit d-none form-control" type="number" name="NamXuatBan" value="@(Model.NamXuatBan?.ToString() ?? "")" /></td></tr>
                                        <tr><td class="fw-semibold">Số tín chỉ:</td><td><span class="tai-lieu-view">@(Model.SoTinChi?.ToString() ?? "")</span><input class="tai-lieu-edit d-none form-control" type="number" name="SoTinChi" value="@(Model.SoTinChi?.ToString() ?? "")" /></td></tr>
                                        break;

                                    case "luận văn":
                                        <tr><td class="fw-semibold">Tên luận văn:</td><td><span class="tai-lieu-view">@Model.TenDeTai</span><input class="tai-lieu-edit d-none form-control" name="TenDeTai" value="@Model.TenDeTai" /></td></tr>
                                        <tr><td class="fw-semibold">Mã số:</td><td><span class="tai-lieu-view">@Model.MaSoDeTai</span><input class="tai-lieu-edit d-none form-control" name="MaSoDeTai" value="@Model.MaSoDeTai" /></td></tr>
                                        <tr><td class="fw-semibold">Sinh viên thực hiện:</td><td><span class="tai-lieu-view">@Model.TacGia</span></td></tr>
                                        <tr><td class="fw-semibold">Giảng viên hướng dẫn:</td><td><span class="tai-lieu-view">@Model.ChuNhiemDeTai</span><input class="tai-lieu-edit d-none form-control" name="ChuNhiemDeTai" value="@Model.ChuNhiemDeTai" /></td></tr>
                                        <tr><td class="fw-semibold">Năm thực hiện:</td><td><span class="tai-lieu-view">@(Model.NamXuatBan?.ToString() ?? "")</span><input class="tai-lieu-edit d-none form-control" type="number" name="NamXuatBan" value="@(Model.NamXuatBan?.ToString() ?? "")" /></td></tr>
                                        <tr><td class="fw-semibold">Chuyên ngành:</td><td><span class="tai-lieu-view">@Model.CapDeTai</span><input class="tai-lieu-edit d-none form-control" name="CapDeTai" value="@Model.CapDeTai" /></td></tr>
                                        break;

                                    case "tài liệu tham khảo":
                                        <tr><td class="fw-semibold">Thông tin bổ sung:</td><td><span class="tai-lieu-view">@(string.IsNullOrEmpty(Model.MoTa) ? "Không có thông tin bổ sung" : Model.MoTa)</span></td></tr>
                                        <tr><td class="fw-semibold">Loại file:</td><td><span class="tai-lieu-view">@Model.LoaiFile</span></td></tr>
                                        <tr><td class="fw-semibold">Kích thước:</td><td><span class="tai-lieu-view">@(Math.Round(Model.KichThuocFile / 1024.0, 1)) MB</span></td></tr>
                                        <tr><td class="fw-semibold">Lượt tải:</td><td><span class="tai-lieu-view">@Model.LuotTai</span></td></tr>
                                        <tr><td class="fw-semibold">Lượt mượn:</td><td><span class="tai-lieu-view">@Model.LuotMuon</span></td></tr>
                                        break;

                                    default:
                                        <tr><td class="fw-semibold">Thông tin bổ sung:</td><td><span class="tai-lieu-view">@(string.IsNullOrEmpty(Model.MoTa) ? "Không có thông tin bổ sung" : Model.MoTa)</span></td></tr>
                                        <tr><td class="fw-semibold">Loại file:</td><td><span class="tai-lieu-view">@Model.LoaiFile</span></td></tr>
                                        <tr><td class="fw-semibold">Kích thước:</td><td><span class="tai-lieu-view">@(Math.Round(Model.KichThuocFile / 1024.0, 1)) MB</span></td></tr>
                                        <tr><td class="fw-semibold">Lượt tải:</td><td><span class="tai-lieu-view">@Model.LuotTai</span></td></tr>
                                        <tr><td class="fw-semibold">Lượt mượn:</td><td><span class="tai-lieu-view">@Model.LuotMuon</span></td></tr>
                                        break;
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="modal-footer border-0 bg-transparent px-0 mt-3 justify-content-end">
            <input type="hidden" id="TaiLieuId" name="MaTaiLieu" value="@Model.MaTaiLieu" />
            <input type="hidden" name="ChoPhepTaiFile" value="@(Model.ChoPhepTaiFile ? "true" : "false")" />
            <div class="mb-2 tai-lieu-edit d-none">
                <label class="form-label">File tài liệu mới (nếu muốn thay):</label>
                <input type="file" class="form-control" id="FileTaiLieuInput" name="FileTaiLieu" />
            </div>
            <div class="mb-3 tai-lieu-edit d-none">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="ChoPhepTaiFile" id="ChoPhepTaiFileInput" value="true" @(Model.ChoPhepTaiFile ? "checked" : "") />
                    <label class="form-check-label" for="ChoPhepTaiFileInput">Cho phép tải file tài liệu</label>
                </div>
            </div>
            <button id="btnEditTaiLieu" type="button" class="btn btn-warning px-4 py-2 rounded-pill me-2" onclick="showEditTaiLieuForm()">
                <i class="fas fa-edit me-1"></i>Sửa
            </button>
            <button id="btnSaveTaiLieu" type="button" class="btn btn-success px-4 py-2 rounded-pill me-2 d-none" onclick="submitEditTaiLieuForm()">
                <i class="fas fa-save me-1"></i>Lưu
            </button>
            <button id="btnCancelEditTaiLieu" type="button" class="btn btn-secondary px-4 py-2 rounded-pill me-2 d-none" onclick="cancelEditTaiLieuForm()">
                <i class="fas fa-times me-1"></i>Hủy
            </button>
            <button type="button" class="btn btn-secondary px-4 py-2 rounded-pill" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i>Đóng
            </button>
<script>
    function showEditTaiLieuForm() {
        document.getElementById('btnEditTaiLieu').classList.add('d-none');
        document.getElementById('btnSaveTaiLieu').classList.remove('d-none');
        document.getElementById('btnCancelEditTaiLieu').classList.remove('d-none');
        document.querySelectorAll('.tai-lieu-view').forEach(e => e.classList.add('d-none'));
        document.querySelectorAll('.tai-lieu-edit').forEach(e => e.classList.remove('d-none'));
    }
    function cancelEditTaiLieuForm() {
        document.getElementById('btnEditTaiLieu').classList.remove('d-none');
        document.getElementById('btnSaveTaiLieu').classList.add('d-none');
        document.getElementById('btnCancelEditTaiLieu').classList.add('d-none');
        document.querySelectorAll('.tai-lieu-view').forEach(e => e.classList.remove('d-none'));
        document.querySelectorAll('.tai-lieu-edit').forEach(e => e.classList.add('d-none'));
    }
    function submitEditTaiLieuForm() {
        var form = document.getElementById('editTaiLieuForm');
        var formData = new FormData(form);
        fetch('/Librarian/EditDocument', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                // Hiển thị thông báo thành công
                if (window.toastr) {
                    toastr.success(result.message || 'Cập nhật thành công!');
                } else {
                    alert(result.message || 'Cập nhật thành công!');
                }
                setTimeout(function() { location.reload(); }, 1000);
            } else {
                alert('Cập nhật thất bại!');
            }
        })
        .catch(() => alert('Có lỗi xảy ra khi cập nhật!'));
    }
</script>
        </div>
    </div>
    </form>
 </div>
