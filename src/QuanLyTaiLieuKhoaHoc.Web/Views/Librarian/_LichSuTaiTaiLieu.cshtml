@model IEnumerable<QuanLyTaiLieuKhoaHoc.Web.Models.LichSuTaiTaiLieu>

<!-- Statistics Cards for Downloads -->
<div class="stats-container">
    <div class="stat-card total">
        <div class="stat-header">
            <div class="stat-icon total">
                <i class="fas fa-download"></i>
            </div>
        </div>
        <div class="stat-number">@(Model?.Count() ?? 0)</div>
        <div class="stat-label">Tổng lượt tải</div>
    </div>
    
    <div class="stat-card active">
        <div class="stat-header">
            <div class="stat-icon active">
                <i class="fas fa-users"></i>
            </div>
        </div>
        <div class="stat-number">@(Model?.Select(x => x.NguoiDung?.Id).Distinct().Count() ?? 0)</div>
        <div class="stat-label">Người dùng đã tải</div>
    </div>
    
    <div class="stat-card inactive">
        <div class="stat-header">
            <div class="stat-icon inactive">
                <i class="fas fa-file-alt"></i>
            </div>
        </div>
        <div class="stat-number">@(Model?.Select(x => x.TaiLieu?.MaTaiLieu).Distinct().Count() ?? 0)</div>
        <div class="stat-label">Tài liệu được tải</div>
    </div>
    
    <div class="stat-card new">
        <div class="stat-header">
            <div class="stat-icon new">
                <i class="fas fa-clock"></i>
            </div>
        </div>
        <div class="stat-number">@(Model?.Where(x => x.ThoiGianTai >= DateTime.Today.AddDays(-7)).Count() ?? 0)</div>
        <div class="stat-label">Tải tuần này</div>
    </div>
</div>

<!-- Download History Table -->
<div class="table-container">
    <div class="table-header">
        <h3><i class="fas fa-history me-2"></i>Lịch sử tải tài liệu gần đây</h3>
        <div class="table-actions">
            <button class="btn-bulk-action" onclick="exportDownloadHistory()">
                <i class="fas fa-download me-1"></i>Xuất lịch sử
            </button>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Người tải</th>
                    <th>Email</th>
                    <th>Tài liệu</th>
                    <th>Loại tài liệu</th>
                    <th>Thời gian tải</th>
                    <th>Trạng thái</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    int stt = 1;
                    @foreach (var item in Model.Take(15))
                    {
                        <tr>
                            <td>@stt</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    @switch (item.NguoiDung?.VaiTro)
                                    {
                                        case VaiTroNguoiDung.ThuThu:
                                            <i class="fas fa-user-shield text-primary me-2"></i>
                                            break;
                                        case VaiTroNguoiDung.GiangVien:
                                            <i class="fas fa-chalkboard-teacher text-success me-2"></i>
                                            break;
                                        case VaiTroNguoiDung.SinhVien:
                                            <i class="fas fa-user-graduate text-warning me-2"></i>
                                            break;
                                        default:
                                            <i class="fas fa-user text-muted me-2"></i>
                                            break;
                                    }
                                    <strong>@(item.NguoiDung?.HoTen ?? "Không xác định")</strong>
                                </div>
                            </td>
                            <td>@(item.NguoiDung?.Email ?? "-")</td>
                            <td>
                                <div class="document-info">
                                    <strong>@(item.TaiLieu?.TenTaiLieu ?? "Không xác định")</strong>
                                    @if (!string.IsNullOrEmpty(item.TaiLieu?.TacGia))
                                    {
                                        <br><small class="text-muted">Tác giả: @item.TaiLieu.TacGia</small>
                                    }
                                </div>
                            </td>
                            <td>
                                @if (item.TaiLieu?.LoaiTaiLieu != null)
                                {
                                    <span class="badge badge-info">@item.TaiLieu.LoaiTaiLieu.TenLoaiTaiLieu</span>
                                }
                                else
                                {
                                    <span class="badge badge-secondary">Không xác định</span>
                                }
                            </td>
                            <td>
                                <div class="time-info">
                                    <div>@item.ThoiGianTai.ToString("dd/MM/yyyy")</div>
                                    <small class="text-muted">@item.ThoiGianTai.ToString("HH:mm")</small>
                                </div>
                            </td>
                            <td>
                                @{
                                    var timeDiff = DateTime.Now - item.ThoiGianTai;
                                    string statusText;
                                    string statusClass;
                                    
                                    if (timeDiff.TotalDays < 1)
                                    {
                                        statusText = "Hôm nay";
                                        statusClass = "badge-success";
                                    }
                                    else if (timeDiff.TotalDays < 7)
                                    {
                                        statusText = "Tuần này";
                                        statusClass = "badge-primary";
                                    }
                                    else if (timeDiff.TotalDays < 30)
                                    {
                                        statusText = "Tháng này";
                                        statusClass = "badge-warning";
                                    }
                                    else
                                    {
                                        statusText = "Cũ";
                                        statusClass = "badge-secondary";
                                    }
                                }
                                <span class="badge @statusClass">@statusText</span>
                            </td>
                        </tr>
                        stt++;
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center empty-state">
                            <i class="fas fa-download fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Chưa có lịch sử tải tài liệu</p>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<script>
    function exportDownloadHistory() {
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xuất...';
        button.disabled = true;
        
        fetch('/ThongKe/ExportReport?type=downloads&format=excel')
            .then(response => {
                button.innerHTML = originalText;
                button.disabled = false;
                toastr.success('Xuất lịch sử tải tài liệu thành công!');
            })
            .catch(error => {
                console.error('Error exporting:', error);
                button.innerHTML = originalText;
                button.disabled = false;
                toastr.error('Lỗi khi xuất lịch sử tải tài liệu!');
            });
    }
</script> 