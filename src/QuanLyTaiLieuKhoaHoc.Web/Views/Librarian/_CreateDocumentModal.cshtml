@model QuanLyTaiLieuKhoaHoc.Web.Models.TaiLieu

<form id="createDocumentForm" enctype="multipart/form-data">
    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

    <div class="row">
        <div class="mb-3">
            <div class="form-check">
                <input asp-for="ChoPhepTaiFile" class="form-check-input" type="checkbox" id="ChoPhepTaiFile">
                <label class="form-check-label" for="ChoPhepTaiFile">
                    <i class="fas fa-download me-1"></i>
                    Cho phép tải file này
                </label>
            </div>
        </div>
        <!-- Dropdown chọn dạng tài liệu -->
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label fw-semibold">
                    <i class="fas fa-list me-1"></i>
                    Dạng tài liệu <span class="text-danger">*</span>
                </label>
                <select id="DocumentType" class="form-select">
                    <option value="">-- Chọn dạng tài liệu --</option>
                    <option value="baibao">Bài báo khoa học</option>
                    <option value="detai">Đề tài nghiên cứu khoa học</option>
                    <option value="giaotrinh">Giáo trình - tài liệu giảng dạy</option>
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label asp-for="TenTaiLieu" class="form-label fw-semibold">
                    <i class="fas fa-file-alt me-1"></i>
                    Tên tài liệu <span class="text-danger">*</span>
                </label>
                <input asp-for="TenTaiLieu" class="form-control" placeholder="Nhập tên tài liệu..." />
                <span asp-validation-for="TenTaiLieu" class="text-danger small"></span>
            </div>
        </div>

        <div class="col-md-6">
            <div class="mb-3">
                <label for="taiLieuFile" class="form-label fw-semibold">
                    <i class="fas fa-upload me-1"></i>
                    File tài liệu <span class="text-danger">*</span>
                </label>
                <input type="file" class="form-control" id="taiLieuFile" name="taiLieuFile"
                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx" />
                <div class="form-text">Chấp nhận: PDF, DOC, DOCX,(Max: 50MB)</div>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <label asp-for="MoTa" class="form-label fw-semibold">
            <i class="fas fa-align-left me-1"></i>
            Mô tả <span class="text-danger">*</span>
        </label>
        <textarea asp-for="MoTa" class="form-control" rows="3"
            placeholder="Nhập mô tả chi tiết về tài liệu..."></textarea>
        <span asp-validation-for="MoTa" class="text-danger small"></span>
    </div>

    <!-- Các trường động theo dạng tài liệu -->
    <div id="baibao-fields" style="display:none;">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label asp-for="TieuDe" class="form-label">Tiêu đề</label>
                <input asp-for="TieuDe" class="form-control" placeholder="Nhập tiêu đề bài báo..." />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="TapChiHoiNghi" class="form-label">Tạp chí/Hội nghị</label>
                <input asp-for="TapChiHoiNghi" class="form-control" placeholder="Nhập tên tạp chí/hội nghị..." />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="NgayCongBo" class="form-label">Ngày công bố</label>
                <input asp-for="NgayCongBo" type="date" class="form-control" />
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label asp-for="DOI" class="form-label">DOI</label>
                <input asp-for="DOI" class="form-control" placeholder="Nhập DOI..." />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="ISSN" class="form-label">ISSN</label>
                <input asp-for="ISSN" class="form-control" placeholder="Nhập ISSN..." />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="CapDo" class="form-label">Cấp độ</label>
                <input asp-for="CapDo" class="form-control" placeholder="Nhập cấp độ..." />
            </div>
        </div>
    </div>

    <div id="detai-fields" style="display:none;">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label asp-for="TenDeTai" class="form-label">Tên đề tài</label>
                <input asp-for="TenDeTai" class="form-control" placeholder="Nhập tên đề tài..." />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="MaSoDeTai" class="form-label">Mã số đề tài</label>
                <input asp-for="MaSoDeTai" class="form-control" placeholder="Nhập mã số đề tài..." />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="CapDeTai" class="form-label">Cấp đề tài</label>
                <input asp-for="CapDeTai" class="form-control" placeholder="Nhập cấp đề tài..." />
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label asp-for="ThoiGianThucHien" class="form-label">Thời gian thực hiện</label>
                <input asp-for="ThoiGianThucHien" class="form-control" placeholder="Nhập thời gian thực hiện..." />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="CoQuanChuTri" class="form-label">Cơ quan chủ trì</label>
                <input asp-for="CoQuanChuTri" class="form-control" placeholder="Nhập cơ quan chủ trì..." />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="ChuNhiemDeTai" class="form-label">Chủ nhiệm đề tài</label>
                <input asp-for="ChuNhiemDeTai" class="form-control" placeholder="Nhập chủ nhiệm đề tài..." />
            </div>
        </div>
    </div>

    <div id="giaotrinh-fields" style="display:none;">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label asp-for="TenGiaoTrinh" class="form-label">Tên giáo trình</label>
                <input asp-for="TenGiaoTrinh" class="form-control" placeholder="Nhập tên giáo trình..." />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="MonHocLienQuan" class="form-label">Môn học liên quan</label>
                <input asp-for="MonHocLienQuan" class="form-control" placeholder="Nhập môn học liên quan..." />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="DonViPhatHanh" class="form-label">Đơn vị phát hành</label>
                <input asp-for="DonViPhatHanh" class="form-control" placeholder="Nhập đơn vị phát hành..." />
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label asp-for="NamXuatBan" class="form-label">Năm xuất bản</label>
                <input asp-for="NamXuatBan" class="form-control" placeholder="Nhập năm xuất bản..." />
            </div>
            <div class="col-md-4 mb-3">
                <label asp-for="SoTinChi" class="form-label">Số tín chỉ</label>
                <input asp-for="SoTinChi" class="form-control" placeholder="Nhập số tín chỉ..." />
            </div>
        </div>
    </div>

    <div class="mb-3">
        <label asp-for="TacGia" class="form-label fw-semibold">
            <i class="fas fa-user-edit me-1"></i>
            Tác giả <span class="text-danger">*</span>
        </label>
        <input asp-for="TacGia" class="form-control" placeholder="Nhập tên tác giả..." />
        <span asp-validation-for="TacGia" class="text-danger small"></span>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label asp-for="MaChuyenNganh" class="form-label fw-semibold">
                    <i class="fas fa-layer-group me-1"></i>
                    Chuyên ngành <span class="text-danger">*</span>
                </label>
                <select asp-for="MaChuyenNganh" class="form-select">
                    <option value="">-- Chọn chuyên ngành --</option>
                    @if (ViewBag.ChuyenNganh != null)
                    {
                        var chuyenNganhList = ViewBag.ChuyenNganh as List<QuanLyTaiLieuKhoaHoc.Web.Models.ChuyenNganh>;
                        if (chuyenNganhList != null)
                        {
                            foreach (var item in chuyenNganhList)
                            {
                                <option value="@item.MaChuyenNganh">@item.TenChuyenNganh</option>
                            }
                        }
                    }
                </select>
                <span asp-validation-for="MaChuyenNganh" class="text-danger small"></span>
            </div>
        </div>

        <div class="col-md-6">
            <div class="mb-3">
                <label asp-for="MaLoaiTaiLieu" class="form-label fw-semibold">
                    <i class="fas fa-tag me-1"></i>
                    Loại tài liệu <span class="text-danger">*</span>
                </label>
                <select asp-for="MaLoaiTaiLieu" class="form-select">
                    <option value="">-- Chọn loại tài liệu --</option>
                    @if (ViewBag.LoaiTaiLieu != null)
                    {
                        var loaiTaiLieuList = ViewBag.LoaiTaiLieu as List<QuanLyTaiLieuKhoaHoc.Web.Models.LoaiTaiLieu>;
                        if (loaiTaiLieuList != null)
                        {
                            foreach (var item in loaiTaiLieuList)
                            {
                                <option value="@item.MaLoaiTaiLieu">@item.TenLoaiTaiLieu</option>
                            }
                        }
                    }
                </select>
                <span asp-validation-for="MaLoaiTaiLieu" class="text-danger small"></span>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Hủy
        </button>
        <button type="submit" class="btn btn-success">
            <i class="fas fa-save me-1"></i>Lưu tài liệu
        </button>
    </div>
</form>

<script>
    $(document).ready(function () {
        // Ẩn/hiện các trường động theo dạng tài liệu
        $('#DocumentType').on('change', function () {
            var type = $(this).val();
            $('#baibao-fields, #detai-fields, #giaotrinh-fields').hide();
            if (type === 'baibao') $('#baibao-fields').show();
            if (type === 'detai') $('#detai-fields').show();
            if (type === 'giaotrinh') $('#giaotrinh-fields').show();
        });

        $('#createDocumentForm').on('submit', function (e) {
            e.preventDefault();

            var formData = new FormData(this);
            var submitBtn = $(this).find('button[type="submit"]');
            var originalText = submitBtn.html();

            // Disable submit button
            submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Đang lưu...');

            $.ajax({
                url: '@Url.Action("CreateDocument")',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        $('#createDocumentModal').modal('hide');

                        // Show success message
                        toastr.success(response.message);

                        // Refresh page or update list
                        setTimeout(function () {
                            location.reload();
                        }, 1000);
                    } else {
                        toastr.error(response.message);
                        if (response.errors) {
                            response.errors.forEach(function (error) {
                                toastr.error(error);
                            });
                        }
                    }
                },
                error: function (xhr, status, error) {
                    toastr.error('Có lỗi xảy ra: ' + error);
                },
                complete: function () {
                    // Re-enable submit button
                    submitBtn.prop('disabled', false).html(originalText);
                }
            });
        });

        // Focus on first input
        $('#TenTaiLieu').focus();
        // Reset các trường động khi mở modal
        $('#DocumentType').val('');
        $('#baibao-fields, #detai-fields, #giaotrinh-fields').hide();
    });
</script>