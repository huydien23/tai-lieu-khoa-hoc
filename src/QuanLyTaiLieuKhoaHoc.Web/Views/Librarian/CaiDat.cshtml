@{
    ViewData["Title"] = "Cài đặt";
    Layout = "~/Views/Shared/_LayoutLibrarian.cshtml";
}

<!-- Modern Settings Header -->
<div class="modern-header">
    <div class="header-background">
        <div class="header-content">
            <div class="header-left">
                <div class="header-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="header-text">
                    <h1 class="header-title">Cài đặt hệ thống</h1>
                    <p class="header-subtitle">Quản lý tài khoản và bảo trì dữ liệu</p>
                </div>
            </div>
            <div class="header-right">
                <div class="header-info">
                    <div class="current-time">
                        <i class="fas fa-clock me-2"></i>
                        <span id="currentDateTime">@DateTime.Now.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div id="notificationContainer" class="notification-container"></div>

<!-- Settings Grid Layout -->
<div class="settings-grid">
    <!-- Account Settings Section -->
    <div class="settings-section">
        <div class="settings-card">
            <div class="settings-card-header">
                <div class="settings-icon">
                    <i class="fas fa-user-cog"></i>
                </div>
                <div class="settings-content">
                    <h5 class="settings-title">Cài đặt tài khoản</h5>
                    <p class="settings-subtitle">Thay đổi mật khẩu và thông tin cá nhân</p>
                </div>
            </div>
            <div class="settings-card-body">
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        @TempData["SuccessMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        @TempData["ErrorMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
                
                <form asp-controller="Account" asp-action="ChangePassword" method="post" autocomplete="off" class="settings-form">
                    <div class="form-group">
                        <label for="currentPassword" class="form-label">
                            <i class="fas fa-lock me-2"></i>Mật khẩu hiện tại
                        </label>
                        <input type="password" class="form-control modern-input" id="currentPassword"
                               name="currentPassword" placeholder="Nhập mật khẩu hiện tại" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword" class="form-label">
                            <i class="fas fa-key me-2"></i>Mật khẩu mới
                        </label>
                        <input type="password" class="form-control modern-input" id="newPassword"
                               name="newPassword" placeholder="Nhập mật khẩu mới" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword" class="form-label">
                            <i class="fas fa-check-circle me-2"></i>Xác nhận mật khẩu mới
                        </label>
                        <input type="password" class="form-control modern-input" id="confirmPassword"
                               name="confirmPassword" placeholder="Xác nhận mật khẩu mới" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary modern-btn">
                            <i class="fas fa-save me-2"></i>Đổi mật khẩu
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- System Maintenance Section -->
    <div class="settings-section">
        <div class="settings-card">
            <div class="settings-card-header">
                <div class="settings-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="settings-content">
                    <h5 class="settings-title">Bảo trì hệ thống</h5>
                    <p class="settings-subtitle">Công cụ bảo trì và sao lưu dữ liệu</p>
                </div>
            </div>
            <div class="settings-card-body">
                <div class="maintenance-tools">
                    <div class="maintenance-tool">
                        <div class="tool-icon">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="tool-content">
                            <h6 class="tool-title">Sao lưu dữ liệu</h6>
                            <p class="tool-description">Tạo bản sao lưu cơ sở dữ liệu</p>
                            <button type="button" class="btn btn-outline-primary modern-btn" id="btnSaoLuuDuLieu">
                                <i class="fas fa-download me-2"></i>Sao lưu dữ liệu
                            </button>
                        </div>
                    </div>
                    
                    <div class="maintenance-tool">
                        <div class="tool-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="tool-content">
                            <h6 class="tool-title">Báo cáo hệ thống</h6>
                            <p class="tool-description">Tạo báo cáo chi tiết về trạng thái hệ thống</p>
                            <button type="button" class="btn btn-outline-info modern-btn" id="btnBaoCaoHeThong">
                                <i class="fas fa-file-alt me-2"></i>Tạo báo cáo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Xử lý nút Sao lưu dữ liệu
    document.addEventListener('DOMContentLoaded', function () {
        var btnSaoLuu = document.getElementById('btnSaoLuuDuLieu');
        if (btnSaoLuu) {
            btnSaoLuu.addEventListener('click', function () {
                // Thêm loading state
                btnSaoLuu.disabled = true;
                btnSaoLuu.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang sao lưu...';
                
                fetch('/Librarian/SaoLuuDuLieu', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name=__RequestVerificationToken]')?.value
                    }
                })
                    .then(res => res.json())
                    .then(data => {
                        showAlert(data.success ? 'success' : 'danger', data.message);
                    })
                    .catch(() => {
                        showAlert('danger', 'Có lỗi xảy ra khi sao lưu dữ liệu!');
                    })
                    .finally(() => {
                        // Khôi phục trạng thái button
                        btnSaoLuu.disabled = false;
                        btnSaoLuu.innerHTML = '<i class="fas fa-download me-2"></i>Sao lưu dữ liệu';
                    });
            });
        }
        
        // Xử lý nút Báo cáo hệ thống
        var btnBaoCao = document.getElementById('btnBaoCaoHeThong');
        if (btnBaoCao) {
            btnBaoCao.addEventListener('click', function () {
                btnBaoCao.disabled = true;
                btnBaoCao.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang tạo báo cáo...';
                
                // Mở báo cáo trong tab mới
                window.open('/Librarian/Statistics', '_blank');
                
                setTimeout(() => {
                    btnBaoCao.disabled = false;
                    btnBaoCao.innerHTML = '<i class="fas fa-file-alt me-2"></i>Tạo báo cáo';
                }, 1000);
            });
        }
        
        // Cập nhật thời gian hiện tại
        function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleDateString('vi-VN') + ' ' + now.toLocaleTimeString('vi-VN');
            document.getElementById('currentDateTime').textContent = dateTimeString;
        }
        
        updateDateTime();
        setInterval(updateDateTime, 1000);
        
        // Load thông tin hệ thống
        loadSystemInfo();
    });
    
    function loadSystemInfo() {
        // Load thống kê cơ bản
        fetch('/Librarian/GetSystemStats')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('totalUsers').textContent = data.totalUsers;
                    document.getElementById('totalDocuments').textContent = data.totalDocuments;
                    document.getElementById('todayBorrows').textContent = data.todayBorrows;
                    document.getElementById('pendingRequests').textContent = data.pendingRequests;
                    document.getElementById('monthlyBorrows').textContent = data.monthlyBorrows;
                    document.getElementById('newDocuments').textContent = data.newDocuments;
                    document.getElementById('newUsers').textContent = data.newUsers;
                    document.getElementById('overdueDocuments').textContent = data.overdueDocuments;
                }
            })
            .catch(() => {
                console.log('Không thể load thông tin hệ thống');
            });
    }
    
    function showAlert(type, message) {
        // Xóa tất cả thông báo cũ
        var container = document.getElementById('notificationContainer');
        container.innerHTML = '';
        
        var alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show';
        alertDiv.role = 'alert';
        alertDiv.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check-circle' : 'exclamation-circle') + ' me-2"></i>' + 
                           message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Đóng"></button>';
        
        container.appendChild(alertDiv);
        
        // Auto hide after 5 seconds
        setTimeout(function () {
            var bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
            bsAlert.close();
        }, 5000);
    }
    

</script>
