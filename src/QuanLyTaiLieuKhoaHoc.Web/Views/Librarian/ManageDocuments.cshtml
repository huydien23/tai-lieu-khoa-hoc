@model IEnumerable<QuanLyTaiLieuKhoaHoc.Web.Models.TaiLieu>
@using QuanLyTaiLieuKhoaHoc.Web.Models

@{
    ViewData["Title"] = "Quản lý Tài liệu";
}

<div class="content-header">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0" style="color: var(--primary-color);" 
            <i class="fas fa-file-alt me-2 text-primary"></i>
            Quản lý Tài liệu
        </h2>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-warning" onclick="fixSoLuongMuonData()">
                <i class="fas fa-sync-alt me-1"></i>Cập nhật lại dữ liệu
            </button>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createDocumentModal">
                <i class="fas fa-plus me-1"></i>Thêm tài liệu
            </button>
            <div class="input-group" style="width: 300px;">
                <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm tài liệu...">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header bg-light">
        <h5 class="mb-0" style=" color: #f9f9f9;">
            <i class="fas fa-list me-2"></i>
            Danh sách tài liệu (@Model.Count() tài liệu)
        </h5>
    </div>
    <div class="card-body p-0">
        @if (!Model.Any())
        {
            <div class="text-center py-5">
                <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                <p class="text-muted">Chưa có tài liệu nào trong hệ thống.</p>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="documentsTable">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">
                                <i class="fas fa-file me-1"></i>
                                Tên tài liệu
                            </th>
                            <th scope="col">
                                <i class="fas fa-user-edit me-1"></i>
                                Tác giả
                            </th>
                            <th scope="col">
                                <i class="fas fa-layer-group me-1"></i>
                                Chuyên ngành
                            </th>
                            <th scope="col">
                                <i class="fas fa-tag me-1"></i>
                                Loại tài liệu
                            </th>
                            <th scope="col">
                                <i class="fas fa-calendar me-1"></i>
                                Ngày tải lên
                            </th>
                            <th scope="col">
                                <i class="fas fa-book-reader me-1"></i>
                                Lượt mượn
                            </th>
                            <th scope="col">
                                <i class="fas fa-copy me-1"></i>
                                Số lượng
                            </th>
                            <th scope="col">
                                <i class="fas fa-info-circle me-1"></i>
                                Trạng thái
                            </th>
                            <th scope="col" class="text-center">
                                <i class="fas fa-cogs me-1"></i>
                                Thao tác
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    <div class="fw-semibold text-primary">@item.TenTaiLieu</div>
                                    <small class="text-muted">@(item.MoTa.Length > 50 ? item.MoTa.Substring(0, 50) + "..." :
                                                                        item.MoTa)</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-user-edit text-secondary me-2"></i>
                                        <span>@item.TacGia</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">@item.ChuyenNganh?.TenChuyenNganh</span>
                                </td>
                                <td>
                                    <span class="badge bg-info text-dark">@item.LoaiTaiLieu?.TenLoaiTaiLieu</span>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        @item.NgayTaiLen.ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                </td>
                                <td>
                                    <span class="badge bg-success">@item.LuotMuon</span>
                                </td>
                                <td>
                                    <div class="d-flex flex-column gap-1">
                                        <span class="badge bg-primary">Tổng: @item.SoLuong</span>
                                        <span class="badge bg-warning">Đã mượn: @item.SoLuongDaMuon</span>
                                        @if (item.SoLuongConLai > 0)
                                        {
                                            <span class="badge bg-success">Còn lại: @item.SoLuongConLai</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">Hết</span>
                                        }
                                    </div>
                                </td>
                                <td>
                                    @switch (item.TrangThai)
                                    {
                                        case TrangThaiTaiLieu.DaDuyet:
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle me-1"></i>
                                                Đã duyệt
                                            </span>
                                            break;
                                        case TrangThaiTaiLieu.ChoDuyet:
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock me-1"></i>
                                                Chờ duyệt
                                            </span>
                                            break;
                                        case TrangThaiTaiLieu.TuChoi:
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times-circle me-1"></i>
                                                Từ chối
                                            </span>
                                            break;
                                    }
                                </td>
                                <td>
                                    <div class="d-flex justify-content-center gap-1">
                                        <button type="button" class="btn btn-outline-primary btn-sm" title="Xem chi tiết"
                                            onclick="viewDocumentDetails(@item.MaTaiLieu)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <!-- Nút lập phiếu mượn: chỉ mở modal chung -->
                                        <button type="button" class="btn btn-outline-warning btn-sm" title="Lập phiếu mượn"
                                            onclick="openCreatePhieuMuonModal(@item.MaTaiLieu, '@item.TenTaiLieu')">
                                            <i class="fas fa-file-signature"></i> Lập phiếu mượn
                                        </button>

                                        @if (item.TrangThai == TrangThaiTaiLieu.ChoDuyet)
                                        {
                                            <form asp-action="ApproveDocument" method="post" style="display: inline;">
                                                <input type="hidden" name="id" value="@item.MaTaiLieu" />
                                                <button type="submit" class="btn btn-outline-success btn-sm" title="Duyệt tài liệu"
                                                    onclick="return confirm('Bạn có chắc chắn muốn duyệt tài liệu này?')">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </form>

                                            <button type="button" class="btn btn-outline-danger btn-sm" title="Từ chối tài liệu"
                                                data-bs-toggle="modal" data-bs-target="#rejectModal"
                                                data-document-id="@item.MaTaiLieu" data-document-name="@item.TenTaiLieu">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        }

                                        @if (!string.IsNullOrEmpty(item.DuongDanFile))
                                        {
                                            <!-- Nút tải tài liệu đã bị loại bỏ theo yêu cầu nghiệp vụ mới -->
                                        }

                                        <button type="button" class="btn btn-outline-danger btn-sm" title="Xóa tài liệu"
                                            onclick="deleteDocument(@item.MaTaiLieu, '@item.TenTaiLieu')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Modal lập phiếu mượn (chỉ render 1 lần ngoài vòng lặp) -->
<div class="modal fade" id="createPhieuMuonModal" tabindex="-1" aria-labelledby="createPhieuMuonModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPhieuMuonModalLabel">
                    <i class="fas fa-file-signature text-warning me-2"></i>
                    Lập phiếu mượn tài liệu
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createPhieuMuonForm">
                <div class="modal-body">
                    <input type="hidden" id="phieuMaTaiLieu" name="maTaiLieu" />
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="true" id="isMemberCheckbox">
                        <label class="form-check-label" for="isMemberCheckbox">
                            Người mượn là thành viên hệ thống
                        </label>
                    </div>
                    <div class="mb-3 d-none" id="memberSearchGroup">
                        <label for="memberSearch" class="form-label">Tìm thành viên (mã số, tên, email)</label>
                        <input type="text" class="form-control" id="memberSearch" autocomplete="off"
                            placeholder="Nhập mã số, tên hoặc email...">
                        <div class="list-group position-absolute w-100" id="memberSearchResults" style="z-index: 1000;">
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6 mb-3">
                            <label for="phieuTenTaiLieu" class="form-label">Tên tài liệu</label>
                            <input type="text" class="form-control" id="phieuTenTaiLieu" name="tenTaiLieu" readonly />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phieuMaNguoiMuon" class="form-label">Mã số người mượn</label>
                            <input type="text" class="form-control" id="phieuMaNguoiMuon" name="maNguoiMuon" required />
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6 mb-3">
                            <label for="phieuHoTenNguoiMuon" class="form-label">Họ tên người mượn</label>
                            <input type="text" class="form-control" id="phieuHoTenNguoiMuon" name="hoTenNguoiMuon"
                                required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phieuEmailNguoiMuon" class="form-label">Email người mượn</label>
                            <input type="email" class="form-control" id="phieuEmailNguoiMuon" name="emailNguoiMuon" />
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6 mb-3">
                            <label for="phieuSDTNguoiMuon" class="form-label">Số điện thoại người mượn</label>
                            <input type="text" class="form-control" id="phieuSDTNguoiMuon" name="sdtNguoiMuon" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phieuLoaiNguoiMuon" class="form-label">Loại người mượn</label>
                            <select class="form-control" id="phieuLoaiNguoiMuon" name="loaiNguoiMuon" required>
                                <option value="">-- Chọn loại người mượn --</option>
                                <option value="Sinh viên">Sinh viên</option>
                                <option value="Giảng viên">Giảng viên</option>
                                <option value="Cán bộ">Cán bộ</option>
                                <option value="Nghiên cứu sinh">Nghiên cứu sinh</option>
                                <option value="Khách">Khách</option>
                                <option value="Khác">Khác</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6 mb-3">
                            <label for="phieuNgayMuon" class="form-label">Ngày mượn</label>
                            <input type="date" class="form-control" id="phieuNgayMuon" name="ngayMuon" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phieuNgayTraDuKien" class="form-label">Ngày trả dự kiến</label>
                            <input type="date" class="form-control" id="phieuNgayTraDuKien" name="ngayTraDuKien" />
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6 mb-3">
                            <label for="phieuSoLuong" class="form-label">Số lượng mượn</label>
                            <input type="number" class="form-control" id="phieuSoLuong" name="soLuong" min="1"
                                value="1" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phieuGhiChu" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="phieuGhiChu" name="ghiChu" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-warning">Lập phiếu mượn</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal từ chối tài liệu -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">
                    <i class="fas fa-times-circle text-danger me-2"></i>
                    Từ chối tài liệu
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="RejectDocument" method="post">
                <div class="modal-body">
                    <input type="hidden" id="rejectDocumentId" name="id" />
                    <p>Bạn có chắc chắn muốn từ chối tài liệu <strong id="rejectDocumentName"></strong>?</p>
                    <div class="mb-3">
                        <label for="lyDo" class="form-label">Lý do từ chối (tùy chọn):</label>
                        <textarea class="form-control" id="lyDo" name="lyDo" rows="3"
                            placeholder="Nhập lý do từ chối tài liệu..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Hủy
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times-circle me-1"></i>Từ chối
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal xem chi tiết tài liệu -->
<div class="modal fade" id="documentDetailsModal" tabindex="-1" aria-labelledby="documentDetailsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentDetailsModalLabel">
                    <i class="fas fa-file-alt text-primary me-2"></i>
                    Chi tiết tài liệu
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="documentDetailsContent">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Đang tải thông tin...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal thêm tài liệu -->
<div class="modal fade" id="createDocumentModal" tabindex="-1" aria-labelledby="createDocumentModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createDocumentModalLabel">
                    <i class="fas fa-plus-circle text-success me-2"></i>
                    Thêm tài liệu mới
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="createDocumentContent">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Đang tải form...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Tìm kiếm tài liệu
        // Hàm mở modal lập phiếu mượn (toàn cục)
        function openCreatePhieuMuonModal(maTaiLieu, tenTaiLieu) {
            $('#phieuMaTaiLieu').val(maTaiLieu);
            $('#phieuTenTaiLieu').val(tenTaiLieu);
            $('#phieuMaNguoiMuon').val("").prop('readonly', false);
            $('#phieuHoTenNguoiMuon').val("").prop('readonly', false);
            $('#phieuEmailNguoiMuon').val("").prop('readonly', false);
            $('#phieuSDTNguoiMuon').val("").prop('readonly', false);
            $('#phieuLoaiNguoiMuon').val("");
            $('#phieuNgayMuon').val(new Date().toISOString().slice(0, 10));
            $('#phieuNgayTraDuKien').val("");
            $('#phieuSoLuong').val(1);
            $('#phieuGhiChu').val("");
            $('#isMemberCheckbox').prop('checked', false);
            $('#memberSearchGroup').addClass('d-none');
            $('#memberSearch').val("");
            $('#memberSearchResults').empty();
            
            // Load thông tin số lượng tài liệu
            loadTaiLieuInfo(maTaiLieu);
            
            $('#createPhieuMuonModal').modal('show');
        }
        window.openCreatePhieuMuonModal = openCreatePhieuMuonModal;

        // Xử lý submit lập phiếu mượn
        $('#createPhieuMuonForm').on('submit', function (e) {
            e.preventDefault();
            var data = {
                maTaiLieu: $('#phieuMaTaiLieu').val(),
                maSoNguoiMuon: $('#phieuMaNguoiMuon').val(),
                hoTenNguoiMuon: $('#phieuHoTenNguoiMuon').val(),
                emailNguoiMuon: $('#phieuEmailNguoiMuon').val(),
                soDienThoaiNguoiMuon: $('#phieuSDTNguoiMuon').val(),
                loaiNguoiMuon: $('#phieuLoaiNguoiMuon').val(),
                ngayMuon: $('#phieuNgayMuon').val(),
                ngayTraDuKien: $('#phieuNgayTraDuKien').val(),
                soLuongMuon: $('#phieuSoLuong').val(),
                ghiChu: $('#phieuGhiChu').val()
            };
            $.ajax({
                url: '/Librarian/LapPhieuMuonTrucTiep',
                type: 'POST',
                data: data,
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message);
                        $('#createPhieuMuonModal').modal('hide');
                        // Refresh page sau 1 giây
                        setTimeout(function () {
                            location.reload();
                        }, 1000);
                    } else {
                        toastr.error(response.message);
                    }
                },
                error: function (xhr, status, error) {
                    toastr.error('Có lỗi xảy ra khi lập phiếu: ' + error);
                }
            });
        });

        // Xử lý checkbox thành viên hệ thống
        $('#isMemberCheckbox').on('change', function () {
            if ($(this).is(':checked')) {
                $('#memberSearchGroup').removeClass('d-none');
                $('#phieuMaNguoiMuon, #phieuHoTenNguoiMuon, #phieuEmailNguoiMuon, #phieuSDTNguoiMuon').prop('readonly', true);
                $('#phieuLoaiNguoiMuon').prop('disabled', true);
            } else {
                $('#memberSearchGroup').addClass('d-none');
                $('#phieuMaNguoiMuon, #phieuHoTenNguoiMuon, #phieuEmailNguoiMuon, #phieuSDTNguoiMuon').prop('readonly', false);
                $('#phieuLoaiNguoiMuon').prop('disabled', false);
                $('#memberSearch').val("");
                $('#memberSearchResults').empty();
            }
        });

        // Autocomplete tìm thành viên hệ thống
        $('#memberSearch').on('input', function () {
            var query = $(this).val();
            if (query.length < 2) {
                $('#memberSearchResults').empty();
                return;
            }
            $.get('/Librarian/SearchMember', { q: query }, function (data) {
                var results = data || [];
                var html = '';
                results.forEach(function (m) {
                    var sdt = m.sdt || 'Chưa có';
                    html += `<button type="button" class="list-group-item list-group-item-action" data-maso="${m.maSo}" data-hoten="${m.hoTen}" data-email="${m.email}" data-sdt="${sdt}" data-loai="${m.loai}">${m.maSo} - ${m.hoTen} (${m.loai}) - ${sdt}</button>`;
                });
                $('#memberSearchResults').html(html);
            });
        });

        // Chọn thành viên từ autocomplete
        $('#memberSearchResults').on('click', 'button', function () {
            var sdt = $(this).data('sdt');
            $('#phieuMaNguoiMuon').val($(this).data('maso'));
            $('#phieuHoTenNguoiMuon').val($(this).data('hoten'));
            $('#phieuEmailNguoiMuon').val($(this).data('email'));
            $('#phieuSDTNguoiMuon').val(sdt === 'Chưa có' ? '' : sdt);
            $('#phieuLoaiNguoiMuon').val($(this).data('loai'));
            $('#memberSearchResults').empty();
        });

        // Tìm kiếm tài liệu
        document.getElementById('searchInput').addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const table = document.getElementById('documentsTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });

        // Xử lý modal từ chối
        const rejectModal = document.getElementById('rejectModal');
        rejectModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const documentId = button.getAttribute('data-document-id');
            const documentName = button.getAttribute('data-document-name');

            document.getElementById('rejectDocumentId').value = documentId;
            document.getElementById('rejectDocumentName').textContent = documentName;
        });

        // Xem chi tiết tài liệu
        function viewDocumentDetails(documentId) {
            $('#documentDetailsModal').modal('show');
            $.get('@Url.Action("GetDocumentDetails")', { id: documentId }, function (data) {
                $('#documentDetailsContent').html(data);
            }).fail(function () {
                $('#documentDetailsContent').html('<div class="alert alert-danger">Có lỗi xảy ra khi tải thông tin!</div>');
            });
        }

        // Load thông tin số lượng tài liệu
        function loadTaiLieuInfo(maTaiLieu) {
            fetch(`/Librarian/GetTaiLieuSoLuong?maTaiLieu=${maTaiLieu}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('soLuongTotal').textContent = `Tổng: ${data.soLuong}`;
                        document.getElementById('soLuongDaMuon').textContent = `Đã mượn: ${data.soLuongDaMuon}`;
                        document.getElementById('soLuongConLai').textContent = `Còn lại: ${data.soLuongConLai}`;
                        
                        // Disable nút lập phiếu nếu hết sách
                        const submitBtn = document.querySelector('#lapPhieuMuonForm button[type="submit"]');
                        if (data.soLuongConLai <= 0) {
                            submitBtn.disabled = true;
                            submitBtn.textContent = 'Hết sách';
                            submitBtn.className = 'btn btn-danger';
                        } else {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Xác nhận lập phiếu mượn';
                            submitBtn.className = 'btn btn-success';
                        }
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi tải thông tin số lượng:', error);
                });
        }

        // Load create document modal
        $('#createDocumentModal').on('show.bs.modal', function (e) {
            $.get('@Url.Action("CreateDocument")', function (data) {
                $('#createDocumentContent').html(data);
            }).fail(function () {
                $('#createDocumentContent').html('<div class="alert alert-danger">Có lỗi xảy ra khi tải form!</div>');
            });
        });

        // Reset modals when hidden
        $('#createDocumentModal').on('hidden.bs.modal', function (e) {
            $('#createDocumentContent').html(`
                                                           <div  class="text-center py-3">
                                                               <div  class="spinner-border text-primary" role="status">
                                                                   <spa n class="visually-hidden">Loading...</spa>
                                                              </di  v>
                                                              <p c  lass="mt-2 text-muted">Đang tải form...</p>
                                                         </di   v>
                                                        `);
        });

        $('#documentDetailsModal').on('hidden.bs.modal', function (e) {
            $('#documentDetailsContent').html(`
                                                        <div     class="text-center py-3">
                                                               <div  class="spinner-border text-primary" role="status">
                                                                   <spa n class="visually-hidden">Loading...</spa>
                                                              </di  v>
                                                              <p c  lass="mt-2 text-muted">Đang tải thông tin...</p>
                                                         </di   v>
                                                        `);
        });

        // Delete document function
        function deleteDocument(id, name) {
            if (confirm(`Bạn có chắc chắn muốn xóa tài liệu "${name}"?\n\nLưu ý: Thao tác này không thể hoàn tác!`)) {
                $.ajax({
                    url: '@Url.Action("DeleteDocument")',
                    type: 'POST',
                    data: { id: id },
                    success: function (response) {
                        if (response.success) {
                            toastr.success(response.message);
                            // Refresh page after 1 second
                            setTimeout(function () {
                                location.reload();
                            }, 1000);
                        } else {
                            toastr.error(response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        toastr.error('Có lỗi xảy ra khi xóa tài liệu: ' + error);
                    }
                });
            }
        }

        // Cập nhật lại dữ liệu số lượng mượn
        function fixSoLuongMuonData() {
            if (confirm('Bạn có chắc chắn muốn cập nhật lại dữ liệu số lượng mượn? Hành động này sẽ đồng bộ lại tất cả phiếu mượn cũ và tính lại số lượng tài liệu.')) {
                fetch('/Librarian/FixSoLuongMuonData', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        toastr.success(data.message);
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        toastr.error(data.message);
                    }
                })
                .catch(error => {
                    toastr.error('Có lỗi xảy ra: ' + error);
                });
            }
        }

        // Make deleteDocument function global
        window.deleteDocument = deleteDocument;
    </script>
}
