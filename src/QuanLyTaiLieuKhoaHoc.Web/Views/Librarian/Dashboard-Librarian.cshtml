@model QuanLyTaiLieuKhoaHoc.Web.Models.ViewModels.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard Thủ thư";
}

@functions {
    public string GetTimeAgo(DateTime time)
    {
        var timeSpan = DateTime.Now - time;
        
        if (timeSpan.TotalMinutes < 1)
            return "Vừa xong";
        else if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} phút trước";
        else if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} giờ trước";
        else
            return $"{(int)timeSpan.TotalDays} ngày trước";
    }
}

<!-- Modern Dashboard Header -->
<div class="modern-header">
    <div class="header-background">
        <div class="header-content">
            <div class="header-left">
                <div class="header-icon">
                    <i class="fas fa-book-reader"></i>
                </div>
                <div class="header-text">
                    <h1 class="header-title">Dashboard Thủ thư</h1>
                    <p class="header-subtitle">Quản lý & giám sát tài liệu khoa học</p>
                </div>
            </div>
            <div class="header-right">
                <div class="header-info">
                    <div class="current-time">
                        <i class="fas fa-clock me-2"></i>
                        <span id="currentDateTime">@DateTime.Now.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name">Thủ thư</span>
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <a href="@Url.Action("Logout", "Account")" class="logout-btn" title="Đăng xuất">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Grid Layout 2x2 -->
<div class="dashboard-grid">
    <!-- Top Left: Hoạt động hôm nay -->
    <div class="dashboard-section">
        <div class="section-header">
            <h5 class="section-title">
                <i class="fas fa-chart-line me-2"></i>
                Hoạt động hôm nay
            </h5>
        </div>
        <div class="activity-cards">
            <div class="activity-card">
                <div class="activity-icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-number">1</div>
                    <div class="activity-label">ĐÃ MƯỢN</div>
                </div>
            </div>
            <div class="activity-card">
                <div class="activity-icon">
                    <i class="fas fa-undo"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-number">0</div>
                    <div class="activity-label">ĐÃ TRẢ</div>
                </div>
            </div>
            <div class="activity-card">
                <div class="activity-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-number">0</div>
                    <div class="activity-label">CHỜ DUYỆT</div>
                </div>
            </div>
            <div class="activity-card">
                <div class="activity-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-number">0</div>
                    <div class="activity-label">ĐANG ONLINE</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Right: Thống kê nhanh -->
    <div class="dashboard-section">
        <div class="section-header">
            <h5 class="section-title">
                <i class="fas fa-list me-2"></i>
                Thống kê nhanh
            </h5>
        </div>
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">@Model.TongSoTaiLieu</div>
                    <div class="stat-label">Tổng tài liệu</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">@Model.TongSoNguoiDung</div>
                    <div class="stat-label">Tổng người dùng</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">@Model.TongSoLuotMuon</div>
                    <div class="stat-label">Lượt mượn tháng</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Left: Tài liệu cần xử lý -->
    <div class="dashboard-section">
        <div class="section-header">
            <h5 class="section-title">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Tài liệu cần xử lý
            </h5>
        </div>
        <div class="process-cards">
            <div class="process-card overdue">
                <div class="process-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="process-content">
                    <div class="process-number">1</div>
                    <div class="process-label">QUÁ HẠN</div>
                </div>
            </div>
            <div class="process-card pending">
                <div class="process-icon">
                    <i class="fas fa-hourglass-half"></i>
                </div>
                <div class="process-content">
                    <div class="process-number">0</div>
                    <div class="process-label">CHỜ DUYỆT</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Right: Hoạt động hệ thống -->
    <div class="dashboard-section">
        <div class="section-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="section-title">
                    <i class="fas fa-bell me-2"></i>
                    Hoạt động hệ thống
                </h5>
                <!-- <a href="#" class="view-all-link">Xem tất cả</a> -->
            </div>
        </div>
        <div class="system-activities">
            @{
                // Lấy số lượng tài liệu quá hạn
                var soTaiLieuQuaHan = Model.SoPhieuDangMuon;
                var nguoiDungMoi = ViewBag.NguoiDungMoi as QuanLyTaiLieuKhoaHoc.Web.Models.NguoiDung;
                
                var activities = new List<dynamic>();
                
                if (soTaiLieuQuaHan > 0)
                {
                    activities.Add(new {
                        Type = ActivityType.TàiLiệuQuáHạn,
                        Title = "Tài liệu quá hạn",
                        Description = $"{soTaiLieuQuaHan} tài liệu đã quá hạn cần xử lý ngay",
                        Time = DateTime.Now.AddMinutes(-5),
                        IconClass = "fas fa-exclamation-triangle",
                        BgColor = "#ef4444",
                        BorderColor = "#ef4444"
                    });
                }
                
                // Thêm thống kê hoạt động
                activities.Add(new {
                    Type = ActivityType.ThốngKêHoạtĐộng,
                    Title = "Thống kê hoạt động",
                    Description = $"Hôm nay có {Model.SoPhieuDangMuon} lượt mượn tài liệu mới",
                    Time = DateTime.Now.AddMinutes(-10),
                    IconClass = "fas fa-chart-line",
                    BgColor = "#10b981",
                    BorderColor = "#10b981"
                });
                
                if (nguoiDungMoi != null)
                {
                    var vaiTroText = nguoiDungMoi.VaiTro switch
                    {
                        VaiTroNguoiDung.SinhVien => "Sinh viên",
                        VaiTroNguoiDung.GiangVien => "Giảng viên",
                        VaiTroNguoiDung.ThuThu => "Thủ thư",
                        _ => "Người dùng"
                    };
                    
                    activities.Add(new {
                        Type = ActivityType.NgườiDùngMớiĐăngKý,
                        Title = "Người dùng mới đăng ký",
                        Description = $"{nguoiDungMoi.HoTen} ({vaiTroText}) đã đăng ký tài khoản mới",
                        Time = nguoiDungMoi.NgayTao,
                        IconClass = "fas fa-user-plus",
                        BgColor = "#10b981",
                        BorderColor = "#10b981"
                    });
                }
                
                if (!activities.Any())
                {
                    activities.Add(new {
                        Type = ActivityType.ThốngKêHoạtĐộng,
                        Title = "Hệ thống hoạt động bình thường",
                        Description = "Không có hoạt động đặc biệt nào cần xử lý",
                        Time = DateTime.Now.AddMinutes(-30),
                        IconClass = "fas fa-check-circle",
                        BgColor = "#6b7280",
                        BorderColor = "#6b7280"
                    });
                }
                
                foreach (var activity in activities)
                {
                    var timeAgo = GetTimeAgo(activity.Time);
                    
                    <div class="system-activity">
                        <div class="activity-border" style="background-color: @activity.BorderColor;"></div>
                        <div class="activity-icon-circle" style="background-color: @activity.BgColor;">
                            <i class="@activity.IconClass"></i>
                        </div>
                        <div class="activity-details">
                            <div class="activity-title">@activity.Title</div>
                            <div class="activity-description">@activity.Description</div>
                            <div class="activity-time">@timeAgo</div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>



@section Scripts {
    <script>
        // Update current time every minute
        function updateCurrentTime() {
            var now = new Date();
            var timeString = now.getDate().toString().padStart(2, '0') + '/' + 
                           (now.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                           now.getFullYear() + ' ' + 
                           now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0');
            document.getElementById('currentDateTime').textContent = timeString;
        }

        // Initialize time update
        updateCurrentTime();
        setInterval(updateCurrentTime, 60000); // Update every minute
    </script>
}